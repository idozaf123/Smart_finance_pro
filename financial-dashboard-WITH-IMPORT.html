<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ××—×•×•× ×™× ×¤×™× × ×¡×™ ×××•×‘×˜×— - Smart Finance Pro</title>

    <!-- App Logo & Favicon -->
    <link rel="icon" type="image/svg+xml" href="smart-finance-logo.svg">
    <link rel="alternate icon" href="smart-finance-logo.svg">
    <link rel="apple-touch-icon" href="smart-finance-logo.svg">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- SortableJS for Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- CryptoJS for Encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        /* CSS VARIABLES & THEMING - NEUMORPHIC EDITION */
        :root {
            --bg-primary: #e0e0e0;
            --bg-secondary: #e0e0e0;
            --bg-tertiary: #e0e0e0;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: transparent;
            --income-color: #27ae60;
            --expense-color: #e74c3c;
            --savings-color: #3498db;
            --warning-color: #f39c12;
            --asset-color: #9b59b6;
            --liability-color: #e91e63;
            --networth-color: #16a085;

            /* Neumorphic shadows */
            --neu-shadow-light: #ffffff;
            --neu-shadow-dark: #bebebe;
            --neu-distance: 8px;

            /* Extruded (raised) effect */
            --shadow-neu-sm: 4px 4px 8px var(--neu-shadow-dark), -4px -4px 8px var(--neu-shadow-light);
            --shadow-neu-md: 8px 8px 16px var(--neu-shadow-dark), -8px -8px 16px var(--neu-shadow-light);
            --shadow-neu-lg: 12px 12px 24px var(--neu-shadow-dark), -12px -12px 24px var(--neu-shadow-light);

            /* Inset (pressed) effect */
            --shadow-neu-inset-sm: inset 4px 4px 8px var(--neu-shadow-dark), inset -4px -4px 8px var(--neu-shadow-light);
            --shadow-neu-inset-md: inset 6px 6px 12px var(--neu-shadow-dark), inset -6px -6px 12px var(--neu-shadow-light);
        }

        [data-theme="dark"] {
            --bg-primary: #2c3e50;
            --bg-secondary: #2c3e50;
            --bg-tertiary: #2c3e50;
            --text-primary: #ecf0f1;
            --text-secondary: #95a5a6;
            --neu-shadow-light: #354556;
            --neu-shadow-dark: #1a252f;
            --shadow-neu-sm: 4px 4px 8px var(--neu-shadow-dark), -4px -4px 8px var(--neu-shadow-light);
            --shadow-neu-md: 8px 8px 16px var(--neu-shadow-dark), -8px -8px 16px var(--neu-shadow-light);
            --shadow-neu-lg: 12px 12px 24px var(--neu-shadow-dark), -12px -12px 24px var(--neu-shadow-light);
            --shadow-neu-inset-sm: inset 4px 4px 8px var(--neu-shadow-dark), inset -4px -4px 8px var(--neu-shadow-light);
            --shadow-neu-inset-md: inset 6px 6px 12px var(--neu-shadow-dark), inset -6px -6px 12px var(--neu-shadow-light);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Arial', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative;
            overflow-x: hidden;
        }

        /* Enhanced Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes floatIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Neumorphic Scrollbar */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bg-primary);
            border-radius: 10px;
            box-shadow: var(--shadow-neu-sm);
            transition: all 0.3s ease;
        }
        ::-webkit-scrollbar-thumb:hover {
            box-shadow: var(--shadow-neu-md);
        }

        /* Neumorphic Asset/Liability Items */
        .asset-item, .liability-item {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 20px;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-neu-md);
            border: none;
            border-right: 4px solid transparent;
        }

        .asset-item { border-right-color: var(--asset-color); }
        .liability-item { border-right-color: var(--liability-color); }

        .asset-item:hover, .liability-item:hover {
            transform: translateX(-4px);
            box-shadow: var(--shadow-neu-lg);
        }

        .item-details { flex: 1; }
        .item-description { font-weight: 600; margin-bottom: 0.25rem; font-size: 1.1rem; }
        .item-amount { font-size: 1.25rem; font-weight: 700; }
        .item-category {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--bg-primary);
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            box-shadow: var(--shadow-neu-inset-sm);
        }
        .item-date { font-size: 0.75rem; color: var(--text-secondary); }

        /* Neumorphic Date Selector */
        .extended-date-selector { display: flex; align-items: center; gap: 0.5rem; }
        .date-nav-btn {
            padding: 0.75rem;
            border-radius: 15px;
            background: var(--bg-primary);
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-neu-md);
            color: var(--text-primary);
        }
        .date-nav-btn:hover {
            box-shadow: var(--shadow-neu-lg);
        }
        .date-nav-btn:active {
            box-shadow: var(--shadow-neu-inset-sm);
        }

        /* Gauge Chart */
        .gauge-container { position: relative; width: 200px; height: 200px; margin: 0 auto; }
        .gauge-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        /* Neumorphic Cards */
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-md);
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-neu-lg);
        }

        /* Enhanced Neumorphic Colored Cards */
        .gradient-income {
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-md), 0 0 0 3px var(--income-color) inset;
            color: var(--text-primary);
            border: none;
        }
        .gradient-expense {
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-md), 0 0 0 3px var(--expense-color) inset;
            color: var(--text-primary);
            border: none;
        }
        .gradient-savings {
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-md), 0 0 0 3px var(--savings-color) inset;
            color: var(--text-primary);
            border: none;
        }
        .gradient-asset {
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-md), 0 0 0 3px var(--asset-color) inset;
            color: var(--text-primary);
            border: none;
        }
        .gradient-liability {
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-md), 0 0 0 3px var(--liability-color) inset;
            color: var(--text-primary);
            border: none;
        }
        .gradient-networth {
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-md), 0 0 0 3px var(--networth-color) inset;
            color: var(--text-primary);
            border: none;
        }

        /* Financial health section */
        .health-score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-lg);
            transition: all 0.4s ease;
        }

        .health-score-circle::after {
            content: '';
            position: absolute;
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-inset-sm);
        }

        .health-score-value {
            position: relative;
            font-size: 3rem;
            font-weight: 700;
            color: var(--text-primary);
            z-index: 1;
            text-align: center;
        }

        .health-grade-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-sm);
            font-weight: 600;
            color: var(--text-primary);
        }

        .health-summary {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .health-focus-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 14px;
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-sm);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .health-progress-wrapper {
            width: 100%;
            height: 14px;
            border-radius: 999px;
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-inset-sm);
            overflow: hidden;
        }

        .health-progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--savings-color), var(--asset-color));
            transition: width 0.6s ease;
        }

        /* Recurring transactions list */
        .recurring-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-radius: 18px;
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-md);
            transition: all 0.3s ease;
        }

        .recurring-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-neu-lg);
        }

        .recurring-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.35rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .recurring-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-inset-sm);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .recurring-amount {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .recurring-direction-income {
            color: var(--income-color);
        }

        .recurring-direction-expense {
            color: var(--expense-color);
        }

        .recurring-missed {
            color: var(--warning-color);
            font-weight: 600;
        }

        /* Neumorphic Modal */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Neumorphic Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 1.25rem 2rem;
            border-radius: 20px;
            box-shadow: var(--shadow-neu-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1100;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast-success {
            border-right: 4px solid var(--income-color);
        }
        .toast-undo {
            cursor: pointer;
            color: var(--savings-color);
            font-weight: 700;
            text-decoration: underline;
            margin-right: 1rem;
        }

        /* Growth badges */
        .growth-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-inset-sm);
        }
        .growth-positive { color: var(--income-color); }
        .growth-negative { color: var(--expense-color); }

        /* Neumorphic Period Selector */
        .period-selector {
            display: inline-flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-primary);
            border-radius: 20px;
            box-shadow: var(--shadow-neu-md);
        }
        .period-btn {
            padding: 0.75rem 1.25rem;
            border-radius: 15px;
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: none;
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-weight: 500;
            box-shadow: var(--shadow-neu-sm);
        }
        .period-btn.active {
            background: var(--bg-primary);
            color: var(--savings-color);
            box-shadow: var(--shadow-neu-inset-md);
            transform: scale(0.98);
        }
        .period-btn:hover:not(.active) {
            box-shadow: var(--shadow-neu-md);
        }
        .period-btn:active:not(.active) {
            box-shadow: var(--shadow-neu-inset-sm);
        }

        /* Neumorphic Transaction Card */
        .transaction-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: var(--bg-primary);
            border-radius: 20px;
            box-shadow: var(--shadow-neu-md);
        }
        .transaction-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-neu-lg);
        }

        /* Drag handle */
        .drag-handle {
            cursor: move;
            color: var(--text-secondary);
            opacity: 0;
            transition: all 0.2s ease;
            font-size: 1.25rem;
            padding: 0 0.5rem;
            user-select: none;
        }
        .transaction-card:hover .drag-handle { opacity: 1; }

        /* Category highlight animation */
        .category-highlight {
            background: var(--bg-primary) !important;
            color: var(--savings-color) !important;
            box-shadow: var(--shadow-neu-inset-md) !important;
            transition: all 0.3s ease;
        }

        /* Category badges */
        .badge-××–×•×Ÿ { background: var(--bg-primary); color: var(--expense-color); box-shadow: var(--shadow-neu-inset-sm); }
        .badge-×ª×—×‘×•×¨×” { background: var(--bg-primary); color: var(--savings-color); box-shadow: var(--shadow-neu-inset-sm); }
        .badge-×“×™×•×¨ { background: var(--bg-primary); color: var(--warning-color); box-shadow: var(--shadow-neu-inset-sm); }
        .badge-×‘×™×“×•×¨ { background: var(--bg-primary); color: var(--asset-color); box-shadow: var(--shadow-neu-inset-sm); }
        .badge-×‘×¨×™××•×ª { background: var(--bg-primary); color: var(--income-color); box-shadow: var(--shadow-neu-inset-sm); }
        .badge-×§× ×™×•×ª { background: var(--bg-primary); color: var(--liability-color); box-shadow: var(--shadow-neu-inset-sm); }
        .badge-×—×©×‘×•× ×•×ª { background: var(--bg-primary); color: var(--warning-color); box-shadow: var(--shadow-neu-inset-sm); }
        .badge-××—×¨ { background: var(--bg-primary); color: var(--text-secondary); box-shadow: var(--shadow-neu-inset-sm); }
        .badge-××©×›×•×¨×ª { background: var(--bg-primary); color: var(--income-color); box-shadow: var(--shadow-neu-inset-sm); }
        .badge-×”×©×§×¢×•×ª { background: var(--bg-primary); color: var(--savings-color); box-shadow: var(--shadow-neu-inset-sm); }

        /* Confirm modal */
        .confirm-modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
        }
        .confirm-modal.show { display: flex; }

        /* Neumorphic Category Management Styles */
        .category-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: none;
            padding-bottom: 0.5rem;
        }

        .category-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border: none;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 15px;
            box-shadow: var(--shadow-neu-sm);
        }

        .category-tab:hover:not(.active) {
            box-shadow: var(--shadow-neu-md);
        }

        .category-tab.active {
            color: var(--savings-color);
            box-shadow: var(--shadow-neu-inset-md);
        }

        .category-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            background: var(--bg-primary);
            border-radius: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-neu-md);
        }

        .category-list-item:hover {
            transform: translateX(-4px);
            box-shadow: var(--shadow-neu-lg);
        }

        .category-badge-custom {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--bg-primary);
            color: var(--savings-color);
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
            box-shadow: var(--shadow-neu-inset-sm);
        }

        /* Neumorphic Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
        }

        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1.25rem;
            background: var(--bg-primary);
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: var(--shadow-neu-sm);
            transition: all 0.3s ease;
        }
        .user-badge:hover {
            box-shadow: var(--shadow-neu-md);
        }

        /* Neumorphic Tabbed Transaction Interface */
        .transaction-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .transaction-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border: none;
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            border-radius: 15px;
            box-shadow: var(--shadow-neu-sm);
        }

        .transaction-tab:hover:not(.active) {
            box-shadow: var(--shadow-neu-md);
        }

        .transaction-tab.active {
            color: var(--savings-color);
            box-shadow: var(--shadow-neu-inset-md);
        }

        .transaction-category-content {
            display: none;
        }

        .transaction-category-content.active {
            display: block;
        }

        /* Enhanced Button Styles */
        button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-sm);
            border: none;
        }

        button:hover {
            box-shadow: var(--shadow-neu-md);
        }

        button:active {
            box-shadow: var(--shadow-neu-inset-sm);
            transform: scale(0.98);
        }

        /* Neumorphic Input Focus States */
        input, select, textarea {
            background: var(--bg-primary);
            box-shadow: var(--shadow-neu-inset-sm);
            border: none;
            color: var(--text-primary);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: var(--shadow-neu-inset-md), 0 0 0 3px var(--savings-color);
        }

        /* Enhanced Rounded Corners for Cards */
        .rounded-2xl {
            border-radius: 24px !important;
        }

        .rounded-xl {
            border-radius: 20px !important;
        }

        .rounded-lg {
            border-radius: 16px !important;
        }

        /* Floating Animation for Key Elements */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .gradient-savings, .gradient-income, .gradient-expense,
        .gradient-asset, .gradient-liability, .gradient-networth {
            animation: float 3s ease-in-out infinite;
        }

        /* Form Container */
        form {
            position: relative;
        }

        /* Enhanced Shadow Layers */
        .shadow-glass {
            box-shadow: var(--shadow-neu-md);
        }

        /* Text Shadow for Better Readability */
        h1, h2, h3, .font-bold {
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        }

        @media (max-width: 768px) {
            .extended-date-selector { flex-wrap: wrap; }
            .drag-handle { opacity: 1; }
            .category-tabs { overflow-x: auto; }
            .transaction-tabs { overflow-x: auto; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container" style="background: var(--bg-primary); display: none;">
        <div class="w-full max-w-md p-8 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(25px) saturate(180%); -webkit-backdrop-filter: blur(25px) saturate(180%); border-radius: 30px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); border: var(--glass-border);">
            <div class="text-center mb-8">
                <div class="w-16 h-16 mx-auto mb-4 rounded-xl gradient-savings flex items-center justify-center text-white text-3xl">
                    ğŸ’°
                </div>
                <h1 class="text-2xl font-bold mb-2">×œ×•×— ××—×•×•× ×™× ×¤×™× × ×¡×™ ×××•×‘×˜×—</h1>
                <p class="text-sm" style="color: var(--text-secondary);">×›× ×™×¡×” ×œ××¢×¨×›×ª</p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="space-y-4">
                <div>
                    <label class="block mb-2 font-medium">×©× ××©×ª××©</label>
                    <input type="text" id="loginUsername" required autocomplete="username"
                           class="w-full px-4 py-3 border outline-none focus:ring-2 transition"
                           style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary); border-radius: 15px;"
                           placeholder="×”×–×Ÿ ×©× ××©×ª××©">
                </div>
                
                <div>
                    <label class="block mb-2 font-medium">×¡×™×¡××”</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password"
                           class="w-full px-4 py-3 border outline-none focus:ring-2 transition"
                           style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary); border-radius: 15px;"
                           placeholder="×”×–×Ÿ ×¡×™×¡××”">
                </div>
                
                <!-- Remember Me Checkbox -->
                <div style="margin-top: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="rememberMe" style="width: auto;">
                        <span style="font-size: 0.9rem;">×–×›×•×¨ ××•×ª×™ ×‘××—×©×‘ ×–×”</span>
                    </label>
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        âš ï¸ ×”×©×ª××© ×¨×§ ×‘××—×©×‘ ××™×©×™ ×××•×‘×˜×—
                    </p>
                </div>
                
                <div id="loginError" class="text-red-600 text-sm hidden p-3 rounded-lg" style="background: #fee2e2;">
                    <span id="loginErrorMessage"></span>
                </div>
                
                <button onclick="handleLogin()" class="w-full py-3 rounded-lg text-white font-medium transition hover:opacity-90" 
                        style="background: var(--savings-color);">ğŸ” ×›× ×™×¡×”</button>
                
                <button onclick="showRegister()" class="w-full py-3 rounded-lg font-medium transition hover:opacity-90" 
                        style="background: var(--bg-tertiary); color: var(--text-primary);">â• ×¦×•×¨ ××©×ª××© ×—×“×©</button>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="space-y-4 hidden">
                <div>
                    <label class="block mb-2 font-medium">×©× ××©×ª××© ×—×“×©</label>
                    <input type="text" id="registerUsername" required autocomplete="username"
                           class="w-full px-4 py-3 border outline-none focus:ring-2 transition"
                           style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary); border-radius: 15px;"
                           placeholder="×‘×—×¨ ×©× ××©×ª××© ×™×™×—×•×“×™">
                </div>
                
                <div>
                    <label class="block mb-2 font-medium">×¡×™×¡××”</label>
                    <input type="password" id="registerPassword" required autocomplete="new-password"
                           class="w-full px-4 py-3 border outline-none focus:ring-2 transition"
                           style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary); border-radius: 15px;"
                           placeholder="×œ×¤×—×•×ª 6 ×ª×•×•×™×">
                    <p class="text-xs mt-1" style="color: var(--text-secondary);">×”×©×ª××© ×‘×¡×™×¡××” ×—×–×§×” - ××™×Ÿ ××¤×©×¨×•×ª ×œ×©×—×–×¨ ×¡×™×¡××” ×©××‘×“×”!</p>
                </div>
                
                <div>
                    <label class="block mb-2 font-medium">××™××•×ª ×¡×™×¡××”</label>
                    <input type="password" id="registerPasswordConfirm" required autocomplete="new-password"
                           class="w-full px-4 py-3 border outline-none focus:ring-2 transition"
                           style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary); border-radius: 15px;"
                           placeholder="×”×–×Ÿ ××ª ×”×¡×™×¡××” ×©×•×‘">
                </div>
                
                <div id="registerError" class="text-red-600 text-sm hidden p-3 rounded-lg" style="background: #fee2e2;">
                    <span id="registerErrorMessage"></span>
                </div>
                
                <div class="p-3 rounded-lg text-sm" style="background: #fef3c7; color: #92400e;">
                    <strong>âš ï¸ ×—×©×•×‘:</strong> ××™×Ÿ ××¤×©×¨×•×ª ×œ×©×—×–×¨ ×¡×™×¡××” ×©××‘×“×”. ×©××•×¨ ××ª ×”×¡×™×¡××” ×‘××§×•× ×‘×˜×•×—!
                </div>
                
                <button onclick="handleRegister()" class="w-full py-3 rounded-lg text-white font-medium transition hover:opacity-90" 
                        style="background: var(--savings-color);">ğŸ’¾ ×¦×•×¨ ××©×ª××©</button>
                
                <button onclick="showLogin()" class="w-full py-3 rounded-lg font-medium transition hover:opacity-90" 
                        style="background: var(--bg-tertiary); color: var(--text-primary);">â†©ï¸ ×—×–×¨×” ×œ×”×ª×—×‘×¨×•×ª</button>
            </div>
        </div>
    </div>

    <!-- Main Application (Hidden until login) -->
    <div id="mainApp" style="display: none;">
        <!-- Header -->
        <header class="sticky top-0 z-50" style="background: var(--glass-bg); backdrop-filter: blur(25px) saturate(180%); -webkit-backdrop-filter: blur(25px) saturate(180%); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border-bottom: var(--glass-border);">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-2xl overflow-hidden shadow-lg" style="background: var(--glass-bg); border: var(--glass-border); backdrop-filter: blur(12px) saturate(160%); -webkit-backdrop-filter: blur(12px) saturate(160%);">
                            <img src="smart-finance-logo.svg" alt="Smart Finance Pro Logo" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">×œ×•×— ××—×•×•× ×™× ×¤×™× × ×¡×™ ×—×›× Pro</h1>
                            <div class="flex items-center gap-2">
                                <p class="text-sm" style="color: var(--text-secondary);">× ×”×œ ××ª ×”×›×¡×¤×™× ×©×œ×š ×‘×—×›××”</p>
                                <span class="user-badge">
                                    <span>ğŸ‘¤</span>
                                    <span id="currentUserDisplay"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <!-- Extended Date Selector with FLIPPED ARROWS -->
                        <div class="extended-date-selector">
                            <button onclick="navigateMonth(-1)" class="date-nav-btn" title="×—×•×“×© ×§×•×“×">â–¶</button>
                            <select id="yearSelector" class="px-3 py-2 rounded-lg border" 
                                    style="background: var(--glass-bg); backdrop-filter: blur(15px) saturate(180%); -webkit-backdrop-filter: blur(15px) saturate(180%); border: var(--glass-border); color: var(--text-primary); border-radius: 15px;"></select>
                            <select id="monthSelector" class="px-3 py-2 rounded-lg border"
                                    style="background: var(--glass-bg); backdrop-filter: blur(15px) saturate(180%); -webkit-backdrop-filter: blur(15px) saturate(180%); border: var(--glass-border); color: var(--text-primary); border-radius: 15px;"></select>
                            <button onclick="navigateMonth(1)" class="date-nav-btn" title="×—×•×“×© ×”×‘×">â—€</button>
                            <button onclick="goToCurrentMonth()" class="date-nav-btn" 
                                    style="background: var(--savings-color); color: white;" 
                                    title="×—×–×•×¨ ×œ×—×•×“×© × ×•×›×—×™">ğŸ“… ×”×™×•×</button>
                        </div>
                        
                        <button onclick="showCategoryManager()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition" title="× ×“×œ ×§×˜×’×•×¨×™×•×ª">
                            <span>âš™ï¸</span>
                        </button>
                        
                        <button onclick="showFinancialRatiosModal()" class="px-4 py-2 rounded-lg text-white transition hover:opacity-90" 
                                style="background: var(--networth-color);" title="×™×—×¡×™× ×¤×™× × ×¡×™×™×">ğŸ“ˆ ×™×—×¡×™× ×¤×™× × ×¡×™×™×</button>
                        
                        <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition" title="××¦×‘ ×›×”×”/×‘×”×™×¨">
                            <span id="themeIcon">ğŸŒ™</span>
                        </button>
                        
                        <button onclick="exportToExcel()" class="px-4 py-2 rounded-lg text-white transition hover:opacity-90" 
                                style="background: var(--savings-color);" title="×™×™×¦×•× ×œ××§×¡×œ">ğŸ“Š ×™×™×¦×•× ×œ××§×¡×œ</button>
                        
                        <button onclick="showImportModal()" class="px-4 py-2 rounded-lg text-white transition hover:opacity-90" 
                                style="background: var(--asset-color);" title="×™×™×‘×•× ×ª× ×•×¢×•×ª ×××§×¡×œ">
                            ğŸ“¥ ×™×™×‘×•× ×××§×¡×œ
                        </button>
                        
                        <button onclick="exportUserData()" class="px-4 py-2 rounded-lg text-white transition hover:opacity-90" 
                                style="background: var(--asset-color);" title="×™×™×¦×•× × ×ª×•× ×™×">ğŸ’¾ ×™×™×¦×•× × ×ª×•× ×™×</button>
                        
                        <button onclick="importUserData()" class="px-4 py-2 rounded-lg text-white transition hover:opacity-90" 
                                style="background: var(--networth-color);" title="×™×™×‘×•× × ×ª×•× ×™×">ğŸ“¥ ×™×™×‘×•×</button>
                        
                        <button onclick="AUTH_SYSTEM.logout()" class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900 transition text-xl" title="×”×ª× ×ª×§">
                            <span>ğŸšª</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <main class="container mx-auto px-4 py-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-8 fade-in">
                <!-- Income Card -->
                <div class="rounded-2xl p-6 text-white gradient-income card-hover cursor-pointer" onclick="showAddModal('income')">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-white/80 text-sm mb-1">×”×›× ×¡×•×ª ×—×•×“×©×™×•×ª</p>
                            <h3 class="text-2xl font-bold" id="totalIncome">â‚ª0</h3>
                        </div>
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center text-xl">ğŸ’µ</div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-white/80">
                        <span>â• ×”×•×¡×£ ×”×›× ×¡×”</span>
                    </div>
                </div>

                <!-- Expense Card -->
                <div class="rounded-2xl p-6 text-white gradient-expense card-hover cursor-pointer" onclick="showAddModal('expense')">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-white/80 text-sm mb-1">×”×•×¦××•×ª ×—×•×“×©×™×•×ª</p>
                            <h3 class="text-2xl font-bold" id="totalExpense">â‚ª0</h3>
                        </div>
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center text-xl">ğŸ’¸</div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-white/80">
                        <span>â• ×”×•×¡×£ ×”×•×¦××”</span>
                    </div>
                </div>

                <!-- Savings Card -->
                <div class="rounded-2xl p-6 text-white gradient-savings">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-white/80 text-sm mb-1">×–××™×Ÿ ×œ×—×™×¡×›×•×Ÿ</p>
                            <h3 class="text-2xl font-bold" id="totalSavings">â‚ª0</h3>
                        </div>
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center text-xl">ğŸ’</div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-white/80">
                        <span id="savingsPercent">0%</span>
                        <span>××”×›× ×¡×•×ª</span>
                    </div>
                    <div id="deficitWarning" class="hidden mt-2 p-2 rounded-lg text-sm font-bold" style="background: rgba(239, 68, 68, 0.2);">
                        âš ï¸ ×’×™×¨×¢×•×Ÿ: <span id="deficitAmount">â‚ª0</span>
                    </div>
                </div>

                <!-- Assets Card -->
                <div class="rounded-2xl p-6 text-white gradient-asset cursor-pointer" onclick="showAssetsModal()">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-white/80 text-sm mb-1">× ×›×¡×™×</p>
                            <h3 class="text-2xl font-bold" id="totalAssets">â‚ª0</h3>
                            <p class="text-xs text-white/60" id="assetsCount">0 ×¤×¨×™×˜×™×</p>
                        </div>
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center text-xl">ğŸ¦</div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-white/80">
                        <span id="assetsChange">0%</span>
                    </div>
                </div>

                <!-- Liabilities Card -->
                <div class="rounded-2xl p-6 text-white gradient-liability cursor-pointer" onclick="showLiabilitiesModal()">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-white/80 text-sm mb-1">×”×ª×—×™×™×‘×•×™×•×ª</p>
                            <h3 class="text-2xl font-bold" id="totalLiabilities">â‚ª0</h3>
                            <p class="text-xs text-white/60" id="liabilitiesCount">0 ×¤×¨×™×˜×™×</p>
                        </div>
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center text-xl">ğŸ’³</div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-white/80">
                        <span id="liabilitiesChange">0%</span>
                    </div>
                </div>

                <!-- Net Worth Card -->
                <div class="rounded-2xl p-6 text-white gradient-networth">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-white/80 text-sm mb-1">×©×•×•×™ × ×§×™</p>
                            <h3 class="text-2xl font-bold" id="netWorth">â‚ª0</h3>
                        </div>
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center text-xl">ğŸ“ˆ</div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-white/80">
                        <span id="netWorthChange">0%</span>
                    </div>
                </div>
            </div>

            <!-- Growth Analysis Section -->
            <div class="rounded-2xl p-6 mb-8 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">ğŸ“Š × ×™×ª×•×— ×¦××™×—×”</h3>
                    <div class="period-selector">
                        <button class="period-btn active" onclick="changeGrowthPeriod('month')">×—×•×“×©×™</button>
                        <button class="period-btn" onclick="changeGrowthPeriod('quarter')">×¨×‘×¢×•× ×™</button>
                        <button class="period-btn" onclick="changeGrowthPeriod('year')">×©× ×ª×™</button>
                        <button class="period-btn" onclick="changeGrowthPeriod('3years')">3 ×©× ×™×</button>
                        <button class="period-btn" onclick="changeGrowthPeriod('5years')">5 ×©× ×™×</button>
                    </div>
                </div>
                <div id="growthAnalysis" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>

            <!-- Financial Health Score -->
            <div class="rounded-2xl p-6 mb-8 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(22px) saturate(185%); -webkit-backdrop-filter: blur(22px) saturate(185%); border: var(--glass-border); box-shadow: 0 12px 45px rgba(0, 0, 0, 0.12);">
                <div class="flex flex-col lg:flex-row gap-6 items-stretch">
                    <div class="flex flex-col items-center justify-center gap-3">
                        <div id="financialHealthScoreCircle" class="health-score-circle">
                            <div class="health-score-value">
                                <div id="financialHealthScore">0</div>
                                <div class="text-sm" style="color: var(--text-secondary);">××ª×•×š 100</div>
                            </div>
                        </div>
                        <span id="financialHealthGrade" class="health-grade-badge">-</span>
                    </div>

                    <div class="flex-1 space-y-5">
                        <div>
                            <h3 class="text-xl font-bold mb-2">âš–ï¸ ××“×“ ×‘×¨×™××•×ª ×¤×™× × ×¡×™×ª</h3>
                            <p id="financialHealthSummary" class="health-summary"></p>
                        </div>

                        <div>
                            <h4 class="text-sm font-semibold" style="color: var(--text-secondary);">×“×’×©×™× ×œ×¤×¢×•×œ×”</h4>
                            <div id="financialFocusList" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2"></div>
                        </div>

                        <div>
                            <h4 class="text-sm font-semibold mb-2" style="color: var(--text-secondary);">×”×ª×§×“××•×ª ×œ×¢×‘×¨ ×™×¢×“ ×”×—×™×¡×›×•×Ÿ ×”×©× ×ª×™</h4>
                            <div class="health-progress-wrapper">
                                <div id="financialHealthProgress" class="health-progress-bar"></div>
                            </div>
                            <div class="flex justify-between text-xs mt-2" style="color: var(--text-secondary);">
                                <span>×”×™×¢×“: 20% ××¡×š ×”×”×›× ×¡×•×ª</span>
                                <span id="financialHealthProgressLabel">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="rounded-2xl p-6 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <h3 class="text-xl font-bold mb-6">××—×•×– ×—×™×¡×›×•×Ÿ</h3>
                    <div class="gauge-container">
                        <canvas id="gaugeChart"></canvas>
                        <div class="gauge-text">
                            <div class="text-4xl font-bold" id="gaugePercent">0%</div>
                            <div class="text-sm" style="color: var(--text-secondary);">××”×™×¢×“</div>
                        </div>
                    </div>
                </div>

                <div class="rounded-2xl p-6 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <h3 class="text-xl font-bold mb-6">×”×ª×¤×œ×’×•×ª ×”×•×¦××•×ª</h3>
                    <canvas id="expenseChart"></canvas>
                </div>

                <div class="rounded-2xl p-6 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <h3 class="text-xl font-bold mb-6">×”×ª×¤×œ×’×•×ª ×”×›× ×¡×•×ª</h3>
                    <canvas id="incomeChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="rounded-2xl p-6 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <h3 class="text-xl font-bold mb-6">××¢×§×‘ ×—×•×“×©×™</h3>
                    <canvas id="trendChart"></canvas>
                </div>

                <div class="rounded-2xl p-6 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <h3 class="text-xl font-bold mb-6">××’××ª ×©×•×•×™ × ×§×™</h3>
                    <canvas id="netWorthChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="rounded-2xl p-6 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <h3 class="text-xl font-bold mb-6">×ª×—×–×™×ª ×ª×–×¨×™× ××–×•×× ×™×</h3>
                    <canvas id="cashFlowForecastChart" style="min-height: 320px;"></canvas>
                </div>

                <div class="rounded-2xl p-6 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">ğŸ” ×ª× ×•×¢×•×ª ×—×•×–×¨×•×ª</h3>
                        <span class="text-xs px-3 py-1 rounded-full" style="background: var(--bg-primary); color: var(--text-secondary); box-shadow: var(--shadow-neu-inset-sm);">6 ×—×•×“×©×™× ××—×¨×•× ×™×</span>
                    </div>
                    <div id="recurringTransactionsList" class="space-y-3"></div>
                </div>
            </div>

            <!-- AI Insights -->
            <div class="rounded-2xl p-6 mb-8 fade-in" style="background: var(--bg-secondary); box-shadow: var(--shadow-md); border-right: 4px solid var(--savings-color);">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span>ğŸ¤–</span>
                    <span>×ª×•×‘× ×•×ª ×—×›××•×ª</span>
                </h3>
                <div id="insightsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </div>

            <!-- Transactions Lists with TABBED INTERFACE -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Income Section with Tabs -->
                <div class="rounded-2xl p-6" style="background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold flex items-center gap-2">
                            <span>ğŸ’°</span>
                            <span>×”×›× ×¡×•×ª</span>
                        </h3>
                        <button onclick="showAddModal('income')" class="px-4 py-2 rounded-lg text-white" 
                                style="background: var(--income-color);">â• ×”×•×¡×£</button>
                    </div>
                    <div id="incomeTabsContainer"></div>
                    <div id="incomeList" class="space-y-3"></div>
                </div>

                <!-- Expense Section with Tabs -->
                <div class="rounded-2xl p-6" style="background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold flex items-center gap-2">
                            <span>ğŸ’¸</span>
                            <span>×”×•×¦××•×ª</span>
                        </h3>
                        <button onclick="showAddModal('expense')" class="px-4 py-2 rounded-lg text-white" 
                                style="background: var(--expense-color);">â• ×”×•×¡×£</button>
                    </div>
                    <div id="expenseTabsContainer"></div>
                    <div id="expenseList" class="space-y-3"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Category Management Modal -->
    <div id="categoryModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="rounded-2xl p-6 max-w-4xl w-full mx-4 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(25px) saturate(180%); -webkit-backdrop-filter: blur(25px) saturate(180%); border: var(--glass-border); box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2); max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">âš™ï¸ × ×™×”×•×œ ×§×˜×’×•×¨×™×•×ª</h2>
                <button onclick="closeCategoryManager()" class="text-2xl hover:opacity-70 transition">Ã—</button>
            </div>
            
            <!-- Tabs -->
            <div class="category-tabs">
                <button class="category-tab active" onclick="switchCategoryTab('income')">×”×›× ×¡×•×ª</button>
                <button class="category-tab" onclick="switchCategoryTab('expense')">×”×•×¦××•×ª</button>
                <button class="category-tab" onclick="switchCategoryTab('assets')">× ×›×¡×™×</button>
                <button class="category-tab" onclick="switchCategoryTab('liabilities')">×”×ª×—×™×™×‘×•×™×•×ª</button>
            </div>
            
            <!-- Add Category Form -->
            <form id="categoryForm" class="mb-6 p-4 rounded-lg" style="background: var(--bg-tertiary);">
                <h3 class="font-bold mb-3">â• ×”×•×¡×£ ×§×˜×’×•×¨×™×” ×—×“×©×”</h3>
                <input type="hidden" id="categoryEditType">
                <input type="hidden" id="categoryEditIndex">
                
                <div class="flex gap-3">
                    <input type="text" id="categoryNameInput" required 
                           placeholder="×©× ×”×§×˜×’×•×¨×™×”..."
                           class="flex-1 px-4 py-3 rounded-lg border outline-none focus:ring-2 transition"
                           style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                    
                    <button type="submit" class="px-6 py-3 rounded-lg text-white font-medium transition hover:opacity-90" 
                            style="background: var(--savings-color);">ğŸ’¾ ×”×•×¡×£</button>
                </div>
            </form>
            
            <!-- Category List -->
            <div>
                <h3 class="font-bold mb-3">ğŸ“‹ ×¨×©×™××ª ×§×˜×’×•×¨×™×•×ª</h3>
                <div id="categoryListContainer" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="rounded-2xl p-6 max-w-md w-full mx-4 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(25px) saturate(180%); -webkit-backdrop-filter: blur(25px) saturate(180%); border: var(--glass-border); box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold" id="modalTitle">×”×•×¡×£ ×ª× ×•×¢×”</h2>
                <button onclick="closeModal()" class="text-2xl hover:opacity-70 transition">Ã—</button>
            </div>
            
            <form id="transactionForm" class="space-y-4">
                <input type="hidden" id="transactionId">
                <input type="hidden" id="transactionType">
                
                <div>
                    <label class="block mb-2 font-medium">×ª×™××•×¨</label>
                    <input type="text" id="description" required 
                           class="w-full px-4 py-3 border outline-none focus:ring-2 transition"
                           style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary); border-radius: 15px;"
                           placeholder="×œ×“×•×’××: ××©×›×•×¨×ª ×—×•×“×©×™×ª">
                </div>
                
                <div>
                    <label class="block mb-2 font-medium">×¡×›×•× (â‚ª)</label>
                    <input type="number" id="amount" required step="0.01" min="0"
                           class="w-full px-4 py-3 border outline-none focus:ring-2 transition"
                           style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary); border-radius: 15px;">
                </div>
                
                <div>
                    <label class="block mb-2 font-medium">×§×˜×’×•×¨×™×”</label>
                    <select id="category" required
                            class="w-full px-4 py-3 rounded-lg border outline-none focus:ring-2 transition"
                            style="background: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);"></select>
                </div>
                
                <div>
                    <label class="block mb-2 font-medium">×ª××¨×™×š</label>
                    <input type="date" id="date" required
                           class="w-full px-4 py-3 border outline-none focus:ring-2 transition"
                           style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary); border-radius: 15px;">
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 py-3 rounded-lg text-white font-medium transition hover:opacity-90" 
                            style="background: var(--savings-color);">ğŸ’¾ ×©××•×¨</button>
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 rounded-lg font-medium transition" 
                            style="background: var(--bg-tertiary); color: var(--text-primary);">×‘×™×˜×•×œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assets/Liabilities Modal -->
    <div id="assetsModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="rounded-2xl p-6 max-w-3xl w-full mx-4 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(25px) saturate(180%); -webkit-backdrop-filter: blur(25px) saturate(180%); border: var(--glass-border); box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2); max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold" id="assetsModalTitle">× ×™×”×•×œ × ×›×¡×™×</h2>
                <button onclick="closeAssetsModal()" class="text-2xl hover:opacity-70 transition">Ã—</button>
            </div>
            
            <div class="mb-4 flex gap-3">
                <button onclick="copyPreviousMonthBalances()" type="button" class="flex-1 py-2 px-4 rounded-lg text-white font-medium transition hover:opacity-90" 
                        style="background: var(--asset-color);">ğŸ“‹ ×”×¢×ª×§ ×™×ª×¨×•×ª ××—×•×“×© ×§×•×“×</button>
            </div>
            
            <form id="assetItemForm" class="space-y-4 mb-6 p-4 rounded-lg" style="background: var(--bg-tertiary);">
                <h3 class="font-bold text-lg mb-3">â• ×”×•×¡×£ ×¤×¨×™×˜ ×—×“×©</h3>
                <input type="hidden" id="assetItemType">
                <input type="hidden" id="assetItemId">
                
                <div>
                    <label class="block mb-2 font-medium">×ª×™××•×¨ ×”×¤×¨×™×˜</label>
                    <input type="text" id="assetDescription" required 
                           placeholder="×œ×“×•×’××: ×—×©×‘×•×Ÿ ×—×™×¡×›×•×Ÿ ×‘× ×§ ×”×¤×•×¢×œ×™× / ××©×›× ×ª× ×“×™×¨×”"
                           class="w-full px-4 py-3 rounded-lg border outline-none focus:ring-2 transition"
                           style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block mb-2 font-medium">×¡×›×•× (â‚ª)</label>
                        <input type="number" id="assetAmount" required step="0.01" min="0"
                               class="w-full px-4 py-3 rounded-lg border outline-none focus:ring-2 transition"
                               style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                    </div>
                    
                    <div>
                        <label class="block mb-2 font-medium">×§×˜×’×•×¨×™×”</label>
                        <select id="assetCategory" required
                                class="w-full px-4 py-3 rounded-lg border outline-none focus:ring-2 transition"
                                style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"></select>
                    </div>
                </div>
                
                <button type="submit" class="w-full py-3 rounded-lg text-white font-medium transition hover:opacity-90" 
                        style="background: var(--savings-color);">ğŸ’¾ ×”×•×¡×£ ×¤×¨×™×˜</button>
            </form>
            
            <div class="mb-4">
                <h3 class="font-bold text-lg mb-3">ğŸ“‹ ×¨×©×™××ª ×¤×¨×™×˜×™×</h3>
                <div id="assetItemsList" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
            
            <div class="mt-6 p-4 rounded-lg font-bold text-xl flex justify-between items-center" 
                 style="background: var(--bg-tertiary);">
                <span>×¡×”"×›:</span>
                <span id="assetModalTotal" class="text-2xl">â‚ª0</span>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>


    <!-- Import Modal -->
    <div id="importModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" onclick="if(event.target === this) closeImportModal()">
        <div class="rounded-2xl p-6 max-w-4xl w-full mx-4 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(25px) saturate(180%); -webkit-backdrop-filter: blur(25px) saturate(180%); border: var(--glass-border); box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2); max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">ğŸ“¥ ×™×™×‘×•× ×ª× ×•×¢×•×ª ×××§×¡×œ</h2>
                <button onclick="closeImportModal()" class="text-2xl hover:opacity-70 transition">Ã—</button>
            </div>
            
            <!-- Step 1: File Upload -->
            <div id="importStep1" class="space-y-4">
                <div class="p-4 rounded-lg text-sm" style="background: #dbeafe; color: #1e40af; border-right: 4px solid var(--savings-color);">
                    <strong>ğŸ’¡ ×›×™×¦×“ ×œ×”×©×ª××©:</strong><br>
                    1. ×”×•×¨×“ ×§×•×‘×¥ Excel ×©×œ ×ª× ×•×¢×•×ª ××”×‘× ×§ (×¢×•×‘×¨ ×•×©×‘, ×œ××•××™, ×“×™×¡×§×•× ×˜, ×”×¤×•×¢×œ×™× ×•×›×•')<br>
                    2. ×”×§×•×‘×¥ ×—×™×™×‘ ×œ×”×›×™×œ ×¢××•×“×•×ª: ×ª××¨×™×š, ×ª×™××•×¨, ×¡×›×•×<br>
                    3. ×œ×—×¥ "×‘×—×¨ ×§×•×‘×¥" ×•×”××¢×¨×›×ª ×ª×–×”×” ××•×˜×•××˜×™ ××ª ×”×§×˜×’×•×¨×™×•×ª
                </div>
                
                <div class="border-2 border-dashed rounded-xl p-8 text-center transition hover:border-blue-500" style="border-color: var(--border-color);">
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" class="hidden" onchange="handleExcelFile(event)">
                    <button onclick="document.getElementById('excelFileInput').click()" 
                            class="px-6 py-3 rounded-lg text-white font-bold transition hover:opacity-90 hover:scale-105"
                            style="background: var(--savings-color);">
                        ğŸ“‚ ×‘×—×¨ ×§×•×‘×¥ Excel
                    </button>
                    <p class="mt-3 text-sm" style="color: var(--text-secondary);">×ª×•××š ×‘-.xlsx ×•-.xls (×¢×“ 10,000 ×ª× ×•×¢×•×ª)</p>
                </div>
                
                <div id="fileInfo" class="hidden p-4 rounded-lg" style="background: var(--bg-tertiary);">
                    <p class="mb-1"><strong>ğŸ“„ ×§×•×‘×¥:</strong> <span id="fileName"></span></p>
                    <p><strong>ğŸ“¦ ×’×•×“×œ:</strong> <span id="fileSize"></span></p>
                </div>
            </div>
            
            <!-- Step 2: Preview & Confirm -->
            <div id="importStep2" class="hidden space-y-4">
                <div class="p-4 rounded-lg" style="background: #dcfce7; border-right: 4px solid var(--income-color);">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">âœ“</span>
                        <strong class="text-lg">× ××¦××• <span id="transactionCount">0</span> ×ª× ×•×¢×•×ª ×—×“×©×•×ª</strong>
                    </div>
                    <p class="text-sm mt-2" style="color: #166534;">
                        <span id="duplicateCount">0</span> ×ª× ×•×¢×•×ª ×›×¤×•×œ×•×ª ×“×•×œ×’×• ××•×˜×•××˜×™×ª
                    </p>
                </div>
                
                <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                    <h4 class="font-bold mb-2">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×”:</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>ğŸ’° ×”×›× ×¡×•×ª: <strong id="incomeCount">0</strong></div>
                        <div>ğŸ’¸ ×”×•×¦××•×ª: <strong id="expenseCount">0</strong></div>
                        <div>âœ“ ×–×™×”×•×™ ×‘×˜×•×— (>80%): <strong id="highConfCount">0</strong></div>
                        <div>âš ï¸ ×œ×‘×“×™×§×” (<80%): <strong id="lowConfCount">0</strong></div>
                    </div>
                </div>
                
                <div class="max-h-96 overflow-y-auto space-y-2" id="previewList"></div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="confirmImport()" class="flex-1 py-3 rounded-lg text-white font-bold text-lg transition hover:opacity-90 hover:scale-105" 
                            style="background: var(--income-color); box-shadow: var(--shadow-md);">
                        âœ“ ××©×¨ ×•×™×™×™×‘×
                    </button>
                    <button onclick="closeImportModal()" class="flex-1 py-3 rounded-lg font-medium transition hover:opacity-90" 
                            style="background: var(--bg-tertiary); color: var(--text-primary);">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </div>
            
            <!-- Processing Indicator -->
            <div id="importProcessing" class="hidden text-center py-12">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 mb-4" 
                     style="border-color: var(--savings-color); border-top-color: transparent;"></div>
                <p class="text-xl font-bold">××¢×‘×“ ××ª ×”×§×•×‘×¥...</p>
                <p class="text-sm mt-2" style="color: var(--text-secondary);">×× × ×”××ª×Ÿ, ×–×” ×™×›×•×œ ×œ×§×—×ª ××¡×¤×¨ ×©× ×™×•×ª</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal" onclick="if(event.target === this) closeConfirmModal()">
        <div class="rounded-2xl p-6 max-w-md w-full mx-4" style="background: var(--glass-bg); backdrop-filter: blur(25px) saturate(180%); -webkit-backdrop-filter: blur(25px) saturate(180%); border: var(--glass-border); box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);">
            <h3 class="text-xl font-bold mb-3">âš ï¸ ××™×©×•×¨ ××—×™×§×”</h3>
            <p class="mb-6" style="color: var(--text-secondary);">×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×ª× ×•×¢×” ×–×•?</p>
            <div class="flex gap-3">
                <button onclick="confirmDelete()" class="flex-1 py-2 rounded-lg text-white font-medium" 
                        style="background: var(--expense-color);">××—×§</button>
                <button onclick="closeConfirmModal()" class="flex-1 py-2 rounded-lg font-medium" 
                        style="background: var(--bg-tertiary); color: var(--text-primary);">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <!-- Financial Ratios Modal -->
    <div id="financialRatiosModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="rounded-2xl p-6 max-w-6xl w-full mx-4 fade-in" style="background: var(--glass-bg); backdrop-filter: blur(25px) saturate(180%); -webkit-backdrop-filter: blur(25px) saturate(180%); border: var(--glass-border); box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2); max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">ğŸ“ˆ × ×™×ª×•×— ×™×—×¡×™× ×¤×™× × ×¡×™×™×</h2>
                <button onclick="closeFinancialRatiosModal()" class="text-2xl hover:opacity-70 transition">Ã—</button>
            </div>
            
            <!-- Disclaimer -->
            <div class="mb-6 p-4 rounded-lg text-sm" style="background: #fef3c7; color: #92400e; border-right: 4px solid #f59e0b;">
                <strong>âš ï¸ ×”×¢×¨×” ×—×©×•×‘×”:</strong> ×”×™×—×¡×™× ×”×¤×™× × ×¡×™×™× ××‘×•×¡×¡×™× ×¢×œ ×¡×™×•×•×’ ××¤×•×©×˜. ×›×œ ×”× ×›×¡×™× ×•×”×ª×—×™×™×‘×•×™×•×ª ××˜×•×¤×œ×™× ×›×©×•×˜×¤×™×. ×”×ª×•×¦××•×ª ×”×Ÿ ××™× ×“×™×§×˜×™×‘×™×•×ª ×‘×œ×‘×“ ×•×¦×¨×™×›×•×ª ×œ×”×ª×¤×¨×© ×‘×–×”×™×¨×•×ª.
            </div>
            
            <!-- Current Ratios -->
            <div class="mb-8">
                <h3 class="text-xl font-bold mb-4">ğŸ“Š ×™×—×¡×™× × ×•×›×—×™×™×</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="currentRatiosGrid"></div>
            </div>
            
            <!-- Trend Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="rounded-xl p-4" style="background: var(--bg-tertiary);">
                    <h3 class="text-lg font-bold mb-4">××’××ª × ×–×™×œ×•×ª ×•××™× ×•×£</h3>
                    <canvas id="ratiosTrendChart1"></canvas>
                </div>
                
                <div class="rounded-xl p-4" style="background: var(--bg-tertiary);">
                    <h3 class="text-lg font-bold mb-4">××’××ª ×—×™×¡×›×•×Ÿ ×•×¨×•×•×—×™×•×ª</h3>
                    <canvas id="ratiosTrendChart2"></canvas>
                </div>
            </div>
            
            <!-- Ratio Definitions -->
            <div class="mt-6 p-4 rounded-lg" style="background: var(--bg-tertiary);">
                <h3 class="text-lg font-bold mb-3">ğŸ“– ×”×’×“×¨×•×ª ×™×—×¡×™×</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <strong>×™×—×¡ × ×–×™×œ×•×ª (Current Ratio):</strong> × ×›×¡×™× ×©×•×˜×¤×™× / ×”×ª×—×™×™×‘×•×™×•×ª ×©×•×˜×¤×•×ª. ×™×¢×“: > 1.5 (×‘×¨×™×)
                    </div>
                    <div>
                        <strong>×™×—×¡ ××™× ×•×£ (Leverage):</strong> ×¡×”"×› ×”×ª×—×™×™×‘×•×™×•×ª / ×¡×”"×› × ×›×¡×™×. ×™×¢×“: < 0.5 (×‘×˜×•×—)
                    </div>
                    <div>
                        <strong>×™×—×¡ ×—×•×‘ ×œ×”×›× ×¡×”:</strong> ×ª×©×œ×•××™ ×—×•×‘ ×—×•×“×©×™×™× / ×”×›× ×¡×” ×—×•×“×©×™×ª. ×™×¢×“: < 0.36 (×¡×‘×™×¨)
                    </div>
                    <div>
                        <strong>×™×—×¡ ×—×™×¡×›×•×Ÿ:</strong> ×—×™×¡×›×•×Ÿ ×—×•×“×©×™ / ×”×›× ×¡×” ×—×•×“×©×™×ª. ×™×¢×“: > 0.20 (××©××¢×ª ×˜×•×‘×”)
                    </div>
                    <div>
                        <strong>×¨×•×•×—×™×•×ª (Net Margin):</strong> ×—×™×¡×›×•×Ÿ ×—×•×“×©×™ / ×¡×”"×› ×”×›× ×¡×•×ª. ×™×¢×“: > 0.15 (×™×¢×™×œ)
                    </div>
                    <div>
                        <strong>×©×•×•×™ × ×§×™:</strong> ×¡×”"×› × ×›×¡×™× - ×¡×”"×› ×”×ª×—×™×™×‘×•×™×•×ª
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ==========================================
           SECURE MULTI-USER FINANCIAL DASHBOARD
           Version: 3.0 with Authentication & Encryption
           Features: User login, encrypted storage, data isolation
        ========================================== */
        
        // Default categories (unchanged base structure)
        const DEFAULT_CATEGORIES = {
            income: {
                '××©×›×•×¨×ª': ['××©×›×•×¨×ª', '×©×›×¨', 'salary', 'wage', '×ª×œ×•×©'],
                '×‘×•× ×•×¡': ['×‘×•× ×•×¡', 'bonus', '×¤×¨×¡', '×ª×’××•×œ', '××¢× ×§'],
                '×”×©×§×¢×•×ª': ['×”×©×§×¢×”', '×“×™×‘×™×“× ×“', '×× ×™×•×ª', '×§×¨×™×¤×˜×•', 'bitcoin', '×¨×™×‘×™×ª', '×ª×©×•××”'],
                '×¢×‘×•×“×” ×¢×¦×××™×ª': ['×¤×¨×™×œ× ×¡', '×¢×¦×××™', 'freelance', '×¤×¨×•×™×§×˜', '×œ×§×•×—', '×—×©×‘×•× ×™×ª'],
                '×©×›×™×¨×•×ª': ['×©×›×™×¨×•×ª', '×“××™ ×©×›×™×¨×•×ª', 'rental', '×”×©×›×¨×”'],
                '××ª× ×”': ['××ª× ×”', 'gift', 'birthday', '×™×•× ×”×•×œ×“×ª'],
                '××—×¨': []
            },
            expense: {
                '××–×•×Ÿ': ['××•×›×œ', '××¡×¢×“×”', '×¡×•×¤×¨', '×©×•×¤×¨×¡×œ', '×¨××™ ×œ×•×™', 'food', 'restaurant', 'cafe', '×¤×™×¦×”', '×”××‘×•×¨×’×¨'],
                '×ª×—×‘×•×¨×”': ['×“×œ×§', '×¨×›×‘', 'taxi', 'uber', '××•×˜×•×‘×•×¡', '×¨×›×‘×ª', '×ª×—×‘×•×¨×”', '×—× ×™×”'],
                '×“×™×•×¨': ['×©×›×™×¨×•×ª', '××©×›× ×ª×', '××¨× ×•× ×”', 'rent', '××™×§××”', 'ikea', '×¨×”×™×˜×™×', '×ª×™×§×•× ×™×'],
                '×‘×™×“×•×¨': ['×§×•×œ× ×•×¢', 'cinema', 'netflix', 'spotify', '××©×—×§', 'game'],
                '×‘×¨×™××•×ª': ['×¨×•×¤×', '×ª×¨×•×¤×•×ª', '×‘×™×˜×•×—', '××›×‘×™', '×›×œ×œ×™×ª', 'doctor', 'pharmacy'],
                '×§× ×™×•×ª': ['×‘×’×“×™×', '× ×¢×œ×™×™×', 'zara', 'h&m', '×§× ×™×•×Ÿ', 'mall'],
                '×—×©×‘×•× ×•×ª': ['×—×©××œ', '××™×', '×’×–', '××™× ×˜×¨× ×˜', '×˜×œ×¤×•×Ÿ', 'bezeq', 'hot'],
                '××—×¨': []
            }
        };
        
        // Asset/Liability default categories
        const DEFAULT_ASSET_CATEGORIES = {
            assets: ['××–×•××Ÿ', '×—×©×‘×•×Ÿ ×‘× ×§', '×—×™×¡×›×•×Ÿ', '×”×©×§×¢×•×ª - ×× ×™×•×ª', '×”×©×§×¢×•×ª - ××’"×—', '×§×¨× ×•×ª × ××× ×•×ª', '×§×¨×™×¤×˜×•', '× ×“×œ"×Ÿ', '×¨×›×‘', '×¦×™×•×“', '×–×”×‘/×ª×›×©×™×˜×™×', '××—×¨'],
            liabilities: ['××©×›× ×ª×', '×”×œ×•×•××ª ×¨×›×‘', '×”×œ×•×•××” ××™×©×™×ª', '×›×¨×˜×™×¡ ××©×¨××™', '××¡×’×¨×ª ××©×¨××™', '×—×•×‘ ×œ×¡×¤×§×™×', '×—×•×‘ ××™×¡×™×', '××—×¨']
        };
        
        /* ==========================================
           AUTHENTICATION SYSTEM
        ========================================== */
        
        const AUTH_SYSTEM = {
            users: [],
            currentUser: null,
            failedAttempts: {},
            
            init() {
                this.loadUsers();
                this.checkRememberedLogin(); // Check for remembered credentials
                this.checkSession();
                
                // Add keyboard shortcuts for login
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                        if (!document.getElementById('loginForm').classList.contains('hidden')) {
                            handleLogin();
                        } else if (!document.getElementById('registerForm').classList.contains('hidden')) {
                            handleRegister();
                        }
                    }
                });
            },
            
            checkRememberedLogin() {
                const remembered = localStorage.getItem('rememberedUser');
                if (remembered) {
                    try {
                        const data = JSON.parse(remembered);
                        // Auto-fill but don't auto-login for security
                        const usernameInput = document.getElementById('loginUsername');
                        const passwordInput = document.getElementById('loginPassword');
                        const rememberCheckbox = document.getElementById('rememberMe');
                        
                        if (usernameInput && passwordInput && rememberCheckbox) {
                            usernameInput.value = data.username;
                            passwordInput.value = atob(data.password);
                            rememberCheckbox.checked = true;
                        }
                    } catch (e) {
                        localStorage.removeItem('rememberedUser');
                    }
                }
            },
            
            checkSession() {
                const userId = sessionStorage.getItem('currentUserId');
                const password = sessionStorage.getItem('userPassword');
                
                if (userId && password) {
                    const user = this.users.find(u => u.id === userId);
                    if (user && this.verifyPassword(user, password)) {
                        this.currentUser = user;
                        this.showDashboard();
                        return;
                    }
                }
                
                this.showLogin();
            },
            
            loadUsers() {
                const usersData = localStorage.getItem('app_users');
                if (usersData) {
                    try {
                        this.users = JSON.parse(usersData);
                    } catch (e) {
                        console.error('Failed to load users:', e);
                        this.users = [];
                    }
                }
            },
            
            saveUsers() {
                localStorage.setItem('app_users', JSON.stringify(this.users));
            },
            
            hashPassword(password) {
                // SHA256 hash
                return CryptoJS.SHA256(password).toString();
            },
            
            deriveKey(password, salt) {
                // PBKDF2 for stronger key derivation
                return CryptoJS.PBKDF2(password, salt, {
                    keySize: 256/32,
                    iterations: 1000
                }).toString();
            },
            
            createUser(username, password) {
                // Check if username exists
                if (this.users.find(u => u.username === username)) {
                    return { success: false, error: '×©× ××©×ª××© ×›×‘×¨ ×§×™×™×' };
                }
                
                // Validate password strength
                if (password.length < 6) {
                    return { success: false, error: '×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 6 ×ª×•×•×™×' };
                }
                
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const salt = CryptoJS.lib.WordArray.random(128/8).toString();
                
                const user = {
                    id: userId,
                    username: username,
                    passwordHash: this.hashPassword(password),
                    salt: salt,
                    createdAt: new Date().toISOString()
                };
                
                this.users.push(user);
                this.saveUsers();
                return { success: true, user: user };
            },
            
            verifyPassword(user, password) {
                return this.hashPassword(password) === user.passwordHash;
            },
            
            checkRateLimit(username) {
                const now = Date.now();
                const attempts = this.failedAttempts[username] || { count: 0, lastAttempt: 0 };
                
                // Reset after 5 minutes
                if (now - attempts.lastAttempt > 5 * 60 * 1000) {
                    this.failedAttempts[username] = { count: 0, lastAttempt: now };
                    return true;
                }
                
                // Max 5 attempts
                if (attempts.count >= 5) {
                    const waitTime = Math.ceil((5 * 60 * 1000 - (now - attempts.lastAttempt)) / 1000);
                    return { blocked: true, waitTime: waitTime };
                }
                
                return true;
            },
            
            recordFailedAttempt(username) {
                const now = Date.now();
                if (!this.failedAttempts[username]) {
                    this.failedAttempts[username] = { count: 0, lastAttempt: now };
                }
                this.failedAttempts[username].count++;
                this.failedAttempts[username].lastAttempt = now;
            },
            
            resetFailedAttempts(username) {
                delete this.failedAttempts[username];
            },
            
            authenticate(username, password) {
                // Check rate limiting
                const rateCheck = this.checkRateLimit(username);
                if (rateCheck.blocked) {
                    return { 
                        success: false, 
                        error: `×™×•×ª×¨ ××“×™ × ×™×¡×™×•× ×•×ª ×›×•×©×œ×™×. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ${rateCheck.waitTime} ×©× ×™×•×ª` 
                    };
                }
                
                const user = this.users.find(u => u.username === username);
                if (!user) {
                    this.recordFailedAttempt(username);
                    return { success: false, error: '×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×' };
                }
                
                if (this.verifyPassword(user, password)) {
                    this.resetFailedAttempts(username);
                    return { success: true, user: user };
                }
                
                this.recordFailedAttempt(username);
                return { success: false, error: '×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×' };
            },
            
            login(username, password) {
                const result = this.authenticate(username, password);
                if (result.success) {
                    this.currentUser = result.user;
                    sessionStorage.setItem('currentUserId', result.user.id);
                    sessionStorage.setItem('userPassword', password);
                    
                    // Set auto-logout after 30 minutes of inactivity
                    this.setupAutoLogout();
                    
                    return true;
                }
                return result.error;
            },
            
            setupAutoLogout() {
                let timeout;
                const resetTimeout = () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        this.logout();
                        showToast('×”×ª× ×ª×§×ª ××•×˜×•××˜×™×ª ×‘×’×œ×œ ×—×•×¡×¨ ×¤×¢×™×œ×•×ª', false);
                    }, 30 * 60 * 1000); // 30 minutes
                };
                
                // Reset on user activity
                ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
                    document.addEventListener(event, resetTimeout, true);
                });
                
                resetTimeout();
            },
            
            logout() {
                this.currentUser = null;
                sessionStorage.removeItem('currentUserId');
                sessionStorage.removeItem('userPassword');
                
                // Clear Remember Me if unchecked
                const rememberMe = document.getElementById('rememberMe');
                if (rememberMe && !rememberMe.checked) {
                    localStorage.removeItem('rememberedUser');
                }
                
                // Clear sensitive data from memory
                transactions = [];
                detailedAssets = {};
                customCategories = {};
                
                // Destroy charts
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {};
                
                this.showLogin();
            },
            
            showLogin() {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('loginError').classList.add('hidden');
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                
                // Check for remembered login
                this.checkRememberedLogin();
                
                // Focus on username field
                setTimeout(() => {
                    const usernameField = document.getElementById('loginUsername');
                    if (usernameField && !usernameField.value) {
                        usernameField.focus();
                    } else {
                        const passwordField = document.getElementById('loginPassword');
                        if (passwordField && !passwordField.value) {
                            passwordField.focus();
                        }
                    }
                }, 100);
            },
            
            showDashboard() {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('currentUserDisplay').textContent = this.currentUser.username;
                
                // Initialize dashboard with user data
                initializeApp();
            }
        };
        
        /* ==========================================
           LOGIN/REGISTER HANDLERS
        ========================================== */
        
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('registerError').classList.add('hidden');
        }
        
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('registerError').classList.add('hidden');
            document.getElementById('registerUsername').focus();
        }
        
        function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked; // Check Remember Me
            
            if (!username || !password) {
                showError('loginError', '× × ×œ×”×–×™×Ÿ ×©× ××©×ª××© ×•×¡×™×¡××”');
                return;
            }
            
            const result = AUTH_SYSTEM.login(username, password);
            if (result === true) {
                // Handle Remember Me
                if (rememberMe) {
                    localStorage.setItem('rememberedUser', JSON.stringify({
                        username: username,
                        password: btoa(password) // Basic encoding, not secure encryption
                    }));
                } else {
                    localStorage.removeItem('rememberedUser');
                }
                AUTH_SYSTEM.showDashboard();
            } else {
                showError('loginError', result);
            }
        }
        
        function handleRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            if (!username || !password || !passwordConfirm) {
                showError('registerError', '× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }
            
            if (password !== passwordConfirm) {
                showError('registerError', '×”×¡×™×¡×××•×ª ××™× ×Ÿ ×ª×•×××•×ª');
                return;
            }
            
            const result = AUTH_SYSTEM.createUser(username, password);
            if (result.success) {
                showToast('×”××©×ª××© × ×•×¦×¨ ×‘×”×¦×œ×—×”! × ×™×ª×Ÿ ×›×¢×ª ×œ×”×ª×—×‘×¨', false);
                showLogin();
                document.getElementById('loginUsername').value = username;
            } else {
                showError('registerError', result.error);
            }
        }
        
        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            const messageEl = document.getElementById(elementId + 'Message');
            messageEl.textContent = message;
            errorEl.classList.remove('hidden');
            
            setTimeout(() => {
                errorEl.classList.add('hidden');
            }, 5000);
        }
        
        /* ==========================================
           ENCRYPTED STORAGE FUNCTIONS
        ========================================== */
        
        function saveUserData(key, data) {
            if (!AUTH_SYSTEM.currentUser) return;
            
            try {
                const password = sessionStorage.getItem('userPassword');
                const salt = AUTH_SYSTEM.currentUser.salt || 'default_salt';
                const encryptionKey = AUTH_SYSTEM.deriveKey(password, salt);
                
                const encrypted = CryptoJS.AES.encrypt(
                    JSON.stringify(data), 
                    encryptionKey
                ).toString();
                
                const storageKey = `user_${AUTH_SYSTEM.currentUser.id}_${key}`;
                localStorage.setItem(storageKey, encrypted);
            } catch (e) {
                console.error('Save failed:', e);
                showToast('×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™×', false);
            }
        }
        
        function loadUserData(key) {
            if (!AUTH_SYSTEM.currentUser) return null;
            
            try {
                const password = sessionStorage.getItem('userPassword');
                const salt = AUTH_SYSTEM.currentUser.salt || 'default_salt';
                const encryptionKey = AUTH_SYSTEM.deriveKey(password, salt);
                
                const storageKey = `user_${AUTH_SYSTEM.currentUser.id}_${key}`;
                const encrypted = localStorage.getItem(storageKey);
                
                if (!encrypted) return null;
                
                const decrypted = CryptoJS.AES.decrypt(encrypted, encryptionKey);
                const data = decrypted.toString(CryptoJS.enc.Utf8);
                
                if (!data) {
                    console.error('Decryption failed for:', key);
                    return null;
                }
                
                return JSON.parse(data);
            } catch (e) {
                console.error('Load failed:', e);
                return null;
            }
        }
        
        /* ==========================================
           EXPORT/IMPORT FUNCTIONS
        ========================================== */
        
        function exportUserData() {
            if (!AUTH_SYSTEM.currentUser) return;
            
            const exportPassword = prompt('×”×–×Ÿ ×¡×™×¡××” ×œ×”×¦×¤× ×ª ×”×™×™×¦×•× (×”×©××¨ ×¨×™×§ ×œ×™×™×¦×•× ×œ×œ× ×”×¦×¤× ×”):');
            
            const exportData = {
                version: '3.0',
                username: AUTH_SYSTEM.currentUser.username,
                exportDate: new Date().toISOString(),
                data: {
                    transactions: transactions,
                    detailedAssets: detailedAssets,
                    customCategories: customCategories
                }
            };
            
            let exportString;
            
            if (exportPassword && exportPassword.trim()) {
                exportString = CryptoJS.AES.encrypt(
                    JSON.stringify(exportData), 
                    exportPassword
                ).toString();
            } else {
                exportString = JSON.stringify(exportData, null, 2);
            }
            
            const blob = new Blob([exportString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance_export_${AUTH_SYSTEM.currentUser.username}_${currentMonth}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('×”× ×ª×•× ×™× ×™×•×¦××• ×‘×”×¦×œ×—×”', false);
        }
        
        function importUserData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        let importString = event.target.result;
                        
                        // Try to detect if encrypted
                        const isEncrypted = !importString.trim().startsWith('{');
                        
                        if (isEncrypted) {
                            const password = prompt('×”×–×Ÿ ×¡×™×¡××ª ×”×¤×¢× ×•×—:');
                            if (!password) return;
                            
                            const decrypted = CryptoJS.AES.decrypt(importString, password);
                            importString = decrypted.toString(CryptoJS.enc.Utf8);
                            
                            if (!importString) {
                                showToast('×¡×™×¡××ª ×¤×¢× ×•×— ×©×’×•×™×”', false);
                                return;
                            }
                        }
                        
                        const importData = JSON.parse(importString);
                        
                        // Validate structure
                        if (!importData.data || !importData.version) {
                            throw new Error('Invalid export format');
                        }
                        
                        // Confirm import
                        if (confirm(`×œ×™×™×‘× × ×ª×•× ×™× ×-${importData.username}?\n×™×™×¦×•× ××ª××¨×™×š: ${new Date(importData.exportDate).toLocaleString('he-IL')}\n\n×¤×¢×•×œ×” ×–×• ×ª×“×¨×•×¡ ××ª ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™×!`)) {
                            transactions = importData.data.transactions || [];
                            detailedAssets = importData.data.detailedAssets || {};
                            customCategories = importData.data.customCategories || {};
                            
                            saveTransactions();
                            saveDetailedAssets();
                            saveCustomCategories();
                            updateDashboard();
                            
                            showToast('×”×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”', false);
                        }
                    } catch (e) {
                        console.error('Import error:', e);
                        showToast('×©×’×™××” ×‘×™×™×‘×•× ×”× ×ª×•× ×™×. ×•×“× ×©×”×§×•×‘×¥ ×ª×§×™×Ÿ ×•×”×¡×™×¡××” × ×›×•× ×”.', false);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Global state
        let currentMonth = '';
        let transactions = [];
        let detailedAssets = {};
        let customCategories = {};
        let charts = {};
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let currentGrowthPeriod = 'month';
        let currentCategoryTab = 'income';
        let activeFilter = { type: null, category: null };
        
        // Undo functionality
        let deletedTransaction = null;
        let deleteTimeout = null;
        let pendingDeleteId = null;
        
        // Sortable instances
        let incomeSortables = [];
        let expenseSortables = [];

        /* ==========================================
           CATEGORY MANAGEMENT FUNCTIONS
        ========================================== */
        
        function loadCustomCategories() {
            const stored = loadUserData('customCategories');
            if (stored) {
                customCategories = stored;
            } else {
                customCategories = {
                    income: [],
                    expense: [],
                    assets: [],
                    liabilities: []
                };
            }
        }
        
        function saveCustomCategories() {
            saveUserData('customCategories', customCategories);
        }
        
        function getAllCategories(type) {
            if (type === 'income' || type === 'expense') {
                const defaults = Object.keys(DEFAULT_CATEGORIES[type]);
                const customs = customCategories[type] || [];
                return [...defaults, ...customs];
            } else {
                const defaults = DEFAULT_ASSET_CATEGORIES[type] || [];
                const customs = customCategories[type] || [];
                return [...defaults, ...customs];
            }
        }
        
        function showCategoryManager() {
            document.getElementById('categoryModal').classList.remove('hidden');
            document.getElementById('categoryModal').classList.add('flex');
            currentCategoryTab = 'income';
            
            // Set active tab
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.category-tab').classList.add('active');
            
            switchCategoryTab('income');
        }
        
        function closeCategoryManager() {
            document.getElementById('categoryModal').classList.add('hidden');
            document.getElementById('categoryModal').classList.remove('flex');
            updateDashboard();
        }
        
        function switchCategoryTab(tab) {
            currentCategoryTab = tab;
            
            document.querySelectorAll('.category-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryEditType').value = '';
            document.getElementById('categoryEditIndex').value = '';
            
            renderCategoryList(tab);
        }
        
        function renderCategoryList(type) {
            const container = document.getElementById('categoryListContainer');
            const allCategories = getAllCategories(type);
            const isTransaction = type === 'income' || type === 'expense';
            const defaults = isTransaction ? Object.keys(DEFAULT_CATEGORIES[type]) : DEFAULT_ASSET_CATEGORIES[type];
            
            if (allCategories.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">××™×Ÿ ×§×˜×’×•×¨×™×•×ª ×œ×”×¦×’×”</p>';
                return;
            }
            
            container.innerHTML = allCategories.map((cat, index) => {
                const isCustom = !defaults.includes(cat);
                return `
                    <div class="category-list-item">
                        <div>
                            ${isCustom ? '<span class="category-badge-custom">××•×ª××</span>' : ''}
                            <span class="font-medium">${cat}</span>
                        </div>
                        ${isCustom ? `
                            <div class="flex gap-2">
                                <button onclick="editCategory('${type}', ${index - defaults.length})" 
                                        class="p-2 rounded hover:bg-blue-100 transition" title="×¢×¨×•×š">âœï¸</button>
                                <button onclick="deleteCategory('${type}', ${index - defaults.length})" 
                                        class="p-2 rounded hover:bg-red-100 transition" title="××—×§">ğŸ—‘ï¸</button>
                            </div>
                        ` : '<span style="color: var(--text-secondary); font-size: 0.875rem;">×‘×¨×™×¨×ª ××—×“×œ</span>'}
                    </div>
                `;
            }).join('');
        }
        
        function editCategory(type, customIndex) {
            const category = customCategories[type][customIndex];
            document.getElementById('categoryNameInput').value = category;
            document.getElementById('categoryEditType').value = type;
            document.getElementById('categoryEditIndex').value = customIndex;
            
            const form = document.getElementById('categoryForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'ğŸ’¾ ×¢×“×›×Ÿ';
        }
        
        function deleteCategory(type, customIndex) {
            if (!confirm('×”×× ×œ××—×•×§ ×§×˜×’×•×¨×™×” ×–×•? ×¤×¢×•×œ×” ×–×• ×œ× ×ª×©×¤×™×¢ ×¢×œ ×ª× ×•×¢×•×ª ×§×™×™××•×ª.')) return;
            
            customCategories[type].splice(customIndex, 1);
            saveCustomCategories();
            renderCategoryList(type);
            showToast('×”×§×˜×’×•×¨×™×” × ××—×§×” ×‘×”×¦×œ×—×”', false);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize category form AFTER DOM is loaded
            const categoryForm = document.getElementById('categoryForm');
            if (categoryForm) {
                categoryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const name = document.getElementById('categoryNameInput').value.trim();
                    const editType = document.getElementById('categoryEditType').value;
                    const editIndex = document.getElementById('categoryEditIndex').value;
                    
                    if (!name) {
                        showToast('×× × ×”×–×Ÿ ×©× ×§×˜×’×•×¨×™×”', false);
                        return;
                    }
                    
                    if (editType && editIndex !== '') {
                        customCategories[editType][parseInt(editIndex)] = name;
                        showToast('×”×§×˜×’×•×¨×™×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”', false);
                    } else {
                        if (!customCategories[currentCategoryTab]) {
                            customCategories[currentCategoryTab] = [];
                        }
                        customCategories[currentCategoryTab].push(name);
                        showToast('×”×§×˜×’×•×¨×™×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”', false);
                    }
                    
                    saveCustomCategories();
                    
                    document.getElementById('categoryForm').reset();
                    document.getElementById('categoryEditType').value = '';
                    document.getElementById('categoryEditIndex').value = '';
                    const submitBtn = document.querySelector('#categoryForm button[type="submit"]');
                    submitBtn.textContent = 'ğŸ’¾ ×”×•×¡×£';
                    
                    renderCategoryList(currentCategoryTab);
                });
            }
            
            // Initialize authentication
            AUTH_SYSTEM.init();
        });

        /* ==========================================
           TIMEZONE & DATE MANAGEMENT
        ========================================== */
        
        function getCurrentMonthJerusalem() {
            const now = new Date();
            const jerusalemTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Jerusalem"}));
            return jerusalemTime.toISOString().slice(0, 7);
        }
        
        function navigateMonth(direction) {
            const year = parseInt(document.getElementById('yearSelector').value);
            const month = parseInt(document.getElementById('monthSelector').value);
            
            let newDate = new Date(year, month - 1 + direction, 1);
            
            if (newDate.getFullYear() < 2020 || newDate.getFullYear() > 2050) {
                showToast('×”×’×¢×ª ×œ×’×‘×•×œ ×”×ª××¨×™×›×™× ×”××•×ª×¨', false);
                return;
            }
            
            document.getElementById('yearSelector').value = newDate.getFullYear();
            document.getElementById('monthSelector').value = newDate.getMonth() + 1;
            updateCurrentMonth();
        }
        
        function goToCurrentMonth() {
            const now = new Date();
            const jerusalemTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Jerusalem"}));
            
            document.getElementById('yearSelector').value = jerusalemTime.getFullYear();
            document.getElementById('monthSelector').value = jerusalemTime.getMonth() + 1;
            updateCurrentMonth();
            showToast('×—×–×¨×ª ×œ×—×•×“×© ×”× ×•×›×—×™', false);
        }
        
        function populateExtendedDateSelector() {
            const yearSelector = document.getElementById('yearSelector');
            const monthSelector = document.getElementById('monthSelector');
            
            const now = new Date();
            const jerusalemTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Jerusalem"}));
            const currentYear = jerusalemTime.getFullYear();
            const currentMonth = jerusalemTime.getMonth() + 1;
            
            const years = [];
            for (let y = 2020; y <= 2050; y++) {
                years.push(y);
            }
            
            yearSelector.innerHTML = years.map(year => 
                `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`
            ).join('');
            
            const months = [
                '×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
                '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'
            ];
            
            monthSelector.innerHTML = months.map((month, idx) => 
                `<option value="${idx + 1}" ${idx + 1 === currentMonth ? 'selected' : ''}>${month}</option>`
            ).join('');
            
            yearSelector.addEventListener('change', updateCurrentMonth);
            monthSelector.addEventListener('change', updateCurrentMonth);
        }
        
        function updateCurrentMonth() {
            const year = document.getElementById('yearSelector').value;
            const month = document.getElementById('monthSelector').value.padStart(2, '0');
            currentMonth = `${year}-${month}`;
            
            if (!detailedAssets[currentMonth]) {
                detailedAssets[currentMonth] = { assets: [], liabilities: [] };
            }
            
            updateDashboard();
        }

        /* ==========================================
           INITIALIZATION
        ========================================== */
        
        function initializeApp() {
            if (!AUTH_SYSTEM.currentUser) {
                AUTH_SYSTEM.showLogin();
                return;
            }
            
            currentMonth = getCurrentMonthJerusalem();
            
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            }
            
            populateExtendedDateSelector();
            
            loadTransactions();
            loadDetailedAssets();
            loadCustomCategories();
            
            if (!detailedAssets[currentMonth]) {
                detailedAssets[currentMonth] = { assets: [], liabilities: [] };
            }
            
            updateDashboard();
            initializeDragAndDrop();
            
            document.getElementById('date').valueAsDate = new Date();
            
            const transForm = document.getElementById('transactionForm');
            if (transForm && !transForm.dataset.listenerAdded) {
                transForm.addEventListener('submit', handleFormSubmit);
                transForm.dataset.listenerAdded = 'true';
            }
            
            const assetForm = document.getElementById('assetItemForm');
            if (assetForm && !assetForm.dataset.listenerAdded) {
                assetForm.addEventListener('submit', handleAssetItemSubmit);
                assetForm.dataset.listenerAdded = 'true';
            }
            
            const descInput = document.getElementById('description');
            if (descInput && !descInput.dataset.listenerAdded) {
                descInput.addEventListener('input', aiCategorize);
                descInput.dataset.listenerAdded = 'true';
            }
        }

        /* ==========================================
           DATA MANAGEMENT - TRANSACTIONS
        ========================================== */
        
        function loadTransactions() {
            const stored = loadUserData('transactions');
            transactions = Array.isArray(stored) ? stored : [];
            normalizeTransactions();
        }

        function saveTransactions() {
            saveUserData('transactions', transactions);
        }

        function getDefaultCategory() {
            return '××—×¨';
        }

        function getTransactionMonthKey(transaction) {
            if (transaction.month) {
                return transaction.month;
            }

            if (transaction.date) {
                return transaction.date.slice(0, 7);
            }

            return null;
        }

        function normalizeTransactions() {
            let changed = false;

            transactions = transactions.map(transaction => {
                if (!transaction) return transaction;

                const normalized = { ...transaction };

                if (normalized.amount !== undefined) {
                    const parsedAmount = parseFloat(normalized.amount);
                    if (!isNaN(parsedAmount) && parsedAmount !== normalized.amount) {
                        normalized.amount = parsedAmount;
                        changed = true;
                    }
                }

                if (!normalized.date && normalized.timestamp) {
                    const date = new Date(normalized.timestamp);
                    if (!isNaN(date.getTime())) {
                        normalized.date = date.toISOString().split('T')[0];
                        changed = true;
                    }
                }

                const monthKey = getTransactionMonthKey(normalized);
                if (!monthKey && normalized.date) {
                    normalized.month = normalized.date.slice(0, 7);
                    changed = true;
                } else if (!normalized.month && monthKey) {
                    normalized.month = monthKey;
                    changed = true;
                }

                if (!normalized.category) {
                    normalized.category = getDefaultCategory();
                    changed = true;
                }

                return normalized;
            });

            if (changed) {
                saveTransactions();
            }
        }

        function addTransaction(transaction) {
            transaction.id = Date.now();
            transaction.amount = parseFloat(transaction.amount);
            if (isNaN(transaction.amount)) {
                transaction.amount = 0;
            }

            if (!transaction.date) {
                transaction.date = new Date().toISOString().split('T')[0];
            }

            transaction.month = transaction.month || getTransactionMonthKey(transaction) || currentMonth;
            transaction.category = transaction.category || getDefaultCategory();
            transactions.push(transaction);
            saveTransactions();
            updateDashboard();
            closeModal();
            showToast('×”×ª× ×•×¢×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”', false);
        }

        function updateTransaction(id, updates) {
            const index = transactions.findIndex(t => t.id === id);
            if (index !== -1) {
                const updated = { ...transactions[index], ...updates };

                if (updated.date) {
                    updated.month = updated.date.slice(0, 7);
                } else if (!updated.month) {
                    const derivedMonth = getTransactionMonthKey(updated);
                    if (derivedMonth) {
                        updated.month = derivedMonth;
                    }
                }

                if (!updated.category) {
                    updated.category = getDefaultCategory();
                }

                if (updated.amount !== undefined) {
                    const parsedAmount = parseFloat(updated.amount);
                    if (!isNaN(parsedAmount)) {
                        updated.amount = parsedAmount;
                    }
                }

                transactions[index] = updated;
                saveTransactions();
                updateDashboard();
                closeModal();
                showToast('×”×ª× ×•×¢×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”', false);
            }
        }

        /* ==========================================
           DATA MANAGEMENT - DETAILED ASSETS
        ========================================== */
        
        function loadDetailedAssets() {
            const stored = loadUserData('detailedAssets');
            detailedAssets = stored || {};
        }
        
        function saveDetailedAssets() {
            saveUserData('detailedAssets', detailedAssets);
        }
        
        function getCurrentAssets() {
            const items = detailedAssets[currentMonth]?.assets || [];
            return items.reduce((sum, item) => sum + item.amount, 0);
        }
        
        function getCurrentLiabilities() {
            const items = detailedAssets[currentMonth]?.liabilities || [];
            return items.reduce((sum, item) => sum + item.amount, 0);
        }

        /* ==========================================
           ASSET/LIABILITY MODAL MANAGEMENT
        ========================================== */
        
        function showAssetsModal() {
            document.getElementById('assetsModal').classList.remove('hidden');
            document.getElementById('assetsModal').classList.add('flex');
            document.getElementById('assetsModalTitle').textContent = '× ×™×”×•×œ × ×›×¡×™×';
            document.getElementById('assetItemType').value = 'assets';
            
            document.getElementById('assetItemForm').reset();
            
            const categorySelect = document.getElementById('assetCategory');
            const categories = getAllCategories('assets');
            categorySelect.innerHTML = categories.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');
            
            renderAssetItems('assets');
        }
        
        function showLiabilitiesModal() {
            document.getElementById('assetsModal').classList.remove('hidden');
            document.getElementById('assetsModal').classList.add('flex');
            document.getElementById('assetsModalTitle').textContent = '× ×™×”×•×œ ×”×ª×—×™×™×‘×•×™×•×ª';
            document.getElementById('assetItemType').value = 'liabilities';
            
            document.getElementById('assetItemForm').reset();
            
            const categorySelect = document.getElementById('assetCategory');
            const categories = getAllCategories('liabilities');
            categorySelect.innerHTML = categories.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');
            
            renderAssetItems('liabilities');
        }
        
        function closeAssetsModal() {
            document.getElementById('assetsModal').classList.add('hidden');
            document.getElementById('assetsModal').classList.remove('flex');
        }
        
        function renderAssetItems(type) {
            const container = document.getElementById('assetItemsList');
            const items = detailedAssets[currentMonth]?.[type] || [];
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8" style="color: var(--text-secondary);">
                        <p>××™×Ÿ ×¤×¨×™×˜×™× ×œ×”×¦×’×”</p>
                        <p class="text-sm mt-2">×”×•×¡×£ ×¤×¨×™×˜×™× ×—×“×©×™× ×‘×××¦×¢×•×ª ×”×˜×•×¤×¡ ×œ××¢×œ×”</p>
                    </div>
                `;
                document.getElementById('assetModalTotal').textContent = 'â‚ª0';
                return;
            }
            
            container.innerHTML = items.map((item, index) => `
                <div class="${type === 'assets' ? 'asset-item' : 'liability-item'}">
                    <div class="item-details">
                        <div class="item-description">${item.description}</div>
                        <span class="item-category">${item.category}</span>
                        <div class="item-date">× ×•×¡×£: ${new Date(item.dateAdded).toLocaleDateString('he-IL')}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="item-amount" style="color: var(--${type === 'assets' ? 'asset' : 'liability'}-color);">
                            ${formatCurrency(item.amount)}
                        </div>
                        <button onclick="editAssetItem('${type}', ${index})" 
                                class="p-2 rounded hover:bg-blue-100 transition" title="×¢×¨×•×š">âœï¸</button>
                        <button onclick="deleteAssetItem('${type}', ${index})" 
                                class="p-2 rounded hover:bg-red-100 transition" title="××—×§">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
            
            const total = items.reduce((sum, item) => sum + item.amount, 0);
            document.getElementById('assetModalTotal').textContent = formatCurrency(total);
        }
        
        function editAssetItem(type, index) {
            const item = detailedAssets[currentMonth][type][index];
            document.getElementById('assetDescription').value = item.description;
            document.getElementById('assetAmount').value = item.amount;
            document.getElementById('assetCategory').value = item.category;
            document.getElementById('assetItemId').value = index;
            
            const submitBtn = document.querySelector('#assetItemForm button[type="submit"]');
            submitBtn.textContent = 'ğŸ’¾ ×¢×“×›×Ÿ ×¤×¨×™×˜';
        }
        
        function deleteAssetItem(type, index) {
            if (!confirm('×”×× ×œ××—×•×§ ×¤×¨×™×˜ ×–×”?')) return;
            
            detailedAssets[currentMonth][type].splice(index, 1);
            saveDetailedAssets();
            renderAssetItems(type);
            updateDashboard();
            showToast('×”×¤×¨×™×˜ × ××—×§ ×‘×”×¦×œ×—×”', false);
        }
        
        function handleAssetItemSubmit(e) {
            e.preventDefault();
            
            const type = document.getElementById('assetItemType').value;
            const itemId = document.getElementById('assetItemId').value;
            const item = {
                description: document.getElementById('assetDescription').value,
                amount: parseFloat(document.getElementById('assetAmount').value),
                category: document.getElementById('assetCategory').value,
                dateAdded: new Date().toISOString()
            };
            
            if (!detailedAssets[currentMonth]) {
                detailedAssets[currentMonth] = { assets: [], liabilities: [] };
            }
            
            if (itemId !== '') {
                detailedAssets[currentMonth][type][parseInt(itemId)] = item;
                showToast('×”×¤×¨×™×˜ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', false);
            } else {
                detailedAssets[currentMonth][type].push(item);
                showToast('×”×¤×¨×™×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”', false);
            }
            
            saveDetailedAssets();
            
            document.getElementById('assetItemForm').reset();
            document.getElementById('assetItemId').value = '';
            const submitBtn = document.querySelector('#assetItemForm button[type="submit"]');
            submitBtn.textContent = 'ğŸ’¾ ×”×•×¡×£ ×¤×¨×™×˜';
            
            renderAssetItems(type);
            updateDashboard();
        }

        /* ==========================================
           TRANSACTION MODAL MANAGEMENT
        ========================================== */
        
        function showAddModal(type) {
            document.getElementById('transactionModal').classList.remove('hidden');
            document.getElementById('transactionModal').classList.add('flex');
            document.getElementById('transactionType').value = type;
            document.getElementById('modalTitle').textContent = type === 'income' ? '×”×•×¡×£ ×”×›× ×¡×”' : '×”×•×¡×£ ×”×•×¦××”';
            
            const categories = getAllCategories(type);
            document.getElementById('category').innerHTML = categories.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');
            
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionId').value = '';
            document.getElementById('date').valueAsDate = new Date();
        }

        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;
            
            showAddModal(transaction.type);
            document.getElementById('transactionId').value = transaction.id;
            document.getElementById('description').value = transaction.description;
            document.getElementById('amount').value = transaction.amount;
            document.getElementById('category').value = transaction.category;
            document.getElementById('date').value = transaction.date;
            document.getElementById('modalTitle').textContent = '×¢×¨×•×š ×ª× ×•×¢×”';
        }

        function closeModal() {
            document.getElementById('transactionModal').classList.add('hidden');
            document.getElementById('transactionModal').classList.remove('flex');
        }

        function handleFormSubmit(e) {
            e.preventDefault();

            const id = document.getElementById('transactionId').value;
            const transaction = {
                type: document.getElementById('transactionType').value,
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value
            };

            transaction.month = getTransactionMonthKey(transaction) || currentMonth;

            if (id) {
                updateTransaction(parseInt(id), transaction);
            } else {
                addTransaction(transaction);
            }
        }

        /* ==========================================
           DELETE FUNCTIONALITY WITH UNDO
        ========================================== */
        
        function deleteTransaction(id) {
            pendingDeleteId = id;
            document.getElementById('confirmModal').classList.add('show');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('show');
            pendingDeleteId = null;
        }

        function confirmDelete() {
            if (!pendingDeleteId) return;
            
            const id = pendingDeleteId;
            closeConfirmModal();
            
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;
            
            deletedTransaction = transaction;
            transactions = transactions.filter(t => t.id !== id);
            saveTransactions();
            updateDashboard();
            showToast('×”×ª× ×•×¢×” × ××—×§×” ×‘×”×¦×œ×—×”', true);
            
            if (deleteTimeout) {
                clearTimeout(deleteTimeout);
            }
            
            deleteTimeout = setTimeout(() => {
                deletedTransaction = null;
            }, 5000);
        }

        function undoDelete() {
            if (!deletedTransaction) return;
            
            transactions.push(deletedTransaction);
            saveTransactions();
            updateDashboard();
            showToast('×”××—×™×§×” ×‘×•×˜×œ×”', false);
            
            deletedTransaction = null;
            if (deleteTimeout) {
                clearTimeout(deleteTimeout);
                deleteTimeout = null;
            }
        }

        /* ==========================================
           UI UTILITIES
        ========================================== */
        
        function showToast(message, showUndo = false) {
            const toast = document.getElementById('toast');
            
            toast.innerHTML = `
                <span>âœ…</span>
                <span>${message}</span>
                ${showUndo ? '<span class="toast-undo" onclick="undoDelete()">â†©ï¸ ×‘×˜×œ</span>' : ''}
            `;
            
            toast.className = 'toast toast-success show';
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, showUndo ? 5000 : 3000);
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            } else {
                document.documentElement.removeAttribute('data-theme');
                document.getElementById('themeIcon').textContent = 'ğŸŒ™';
            }
            
            updateDashboard();
        }

        /* ==========================================
           DRAG & DROP FUNCTIONALITY
        ========================================== */
        
        function destroySortables(instances) {
            instances.forEach(instance => instance.destroy());
            instances.length = 0;
        }

        function initializeDragAndDrop() {
            const incomeContents = document.querySelectorAll('#incomeList .transaction-category-content');
            if (incomeContents.length > 0) {
                destroySortables(incomeSortables);

                incomeContents.forEach(content => {
                    const sortable = new Sortable(content, {
                        animation: 150,
                        handle: '.drag-handle',
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen'
                    });
                    incomeSortables.push(sortable);
                });
            }

            const expenseContents = document.querySelectorAll('#expenseList .transaction-category-content');
            if (expenseContents.length > 0) {
                destroySortables(expenseSortables);

                expenseContents.forEach(content => {
                    const sortable = new Sortable(content, {
                        animation: 150,
                        handle: '.drag-handle',
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen'
                    });
                    expenseSortables.push(sortable);
                });
            }
        }

        /* ==========================================
           AI CATEGORIZATION
        ========================================== */
        
        function aiCategorize() {
            const description = document.getElementById('description').value.toLowerCase();
            const type = document.getElementById('transactionType').value;
            
            if (!description || description.length < 3) return;
            
            const categories = DEFAULT_CATEGORIES[type];
            
            for (const [category, keywords] of Object.entries(categories)) {
                for (const keyword of keywords) {
                    if (description.includes(keyword.toLowerCase())) {
                        document.getElementById('category').value = category;
                        const categorySelect = document.getElementById('category');
                        categorySelect.classList.add('category-highlight');
                        setTimeout(() => {
                            categorySelect.classList.remove('category-highlight');
                        }, 1000);
                        return;
                    }
                }
            }
        }

        /* ==========================================
           CALCULATIONS
        ========================================== */
        
        function getMonthTransactions() {
            return transactions.filter(t => getTransactionMonthKey(t) === currentMonth);
        }

        function getTransactionsByMonth(monthKey) {
            return transactions.filter(t => getTransactionMonthKey(t) === monthKey);
        }

        function calculateTotals() {
            const monthTrans = getMonthTransactions();

            const income = monthTrans
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const expense = monthTrans
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const savings = income - expense;
            const savingsPercent = income > 0 ? (savings / income * 100) : 0;
            const goalPercent = savingsPercent / 20 * 100;
            
            return { income, expense, savings, savingsPercent, goalPercent };
        }

        function calculateGrowth(current, previous) {
            if (previous === 0) return current > 0 ? 100 : 0;
            return ((current - previous) / Math.abs(previous)) * 100;
        }

        function getDateMonthsAgo(months) {
            const [year, month] = currentMonth.split('-').map(Number);
            const date = new Date(year, month - 1);
            date.setMonth(date.getMonth() - months);
            return date.toISOString().slice(0, 7);
        }

        function getDateMonthsAhead(months) {
            const [year, month] = currentMonth.split('-').map(Number);
            const date = new Date(year, month - 1);
            date.setMonth(date.getMonth() + months);
            return date.toISOString().slice(0, 7);
        }

        /* ==========================================
           GROWTH ANALYSIS
        ========================================== */
        
        function changeGrowthPeriod(period) {
            currentGrowthPeriod = period;
            
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateGrowthAnalysis();
        }

        function updateGrowthAnalysis() {
            const container = document.getElementById('growthAnalysis');
            const currentAssets = getCurrentAssets();
            const currentLiabilities = getCurrentLiabilities();
            const netWorth = currentAssets - currentLiabilities;
            
            let previousAssets = 0;
            let previousLiabilities = 0;
            let periodLabel = '';
            
            const periodsMap = {
                'month': { months: 1, label: '×œ×¢×•××ª ×—×•×“×© ×§×•×“×' },
                'quarter': { months: 3, label: '×œ×¢×•××ª ×¨×‘×¢×•×Ÿ ×§×•×“×' },
                'year': { months: 12, label: '×œ×¢×•××ª ×©× ×” ×§×•×“××ª' },
                '3years': { months: 36, label: '×œ×¢×•××ª 3 ×©× ×™×' },
                '5years': { months: 60, label: '×œ×¢×•××ª 5 ×©× ×™×' }
            };
            
            const period = periodsMap[currentGrowthPeriod];
            const previousMonth = getDateMonthsAgo(period.months);
            const previousData = detailedAssets[previousMonth];
            
            if (previousData) {
                previousAssets = previousData.assets?.reduce((sum, item) => sum + item.amount, 0) || 0;
                previousLiabilities = previousData.liabilities?.reduce((sum, item) => sum + item.amount, 0) || 0;
            }
            
            periodLabel = period.label;
            
            const previousNetWorth = previousAssets - previousLiabilities;
            const assetsGrowth = calculateGrowth(currentAssets, previousAssets);
            const liabilitiesGrowth = calculateGrowth(currentLiabilities, previousLiabilities);
            const netWorthGrowth = calculateGrowth(netWorth, previousNetWorth);
            
            const totals = calculateTotals();
            const prevMonthTrans = transactions.filter(t => t.month === getDateMonthsAgo(1));
            const prevIncome = prevMonthTrans.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const incomeGrowth = calculateGrowth(totals.income, prevIncome);
            
            container.innerHTML = `
                <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                    <div class="text-sm mb-1" style="color: var(--text-secondary);">× ×›×¡×™× ${periodLabel}</div>
                    <div class="text-xl font-bold mb-2">${formatCurrency(currentAssets)}</div>
                    <div class="growth-badge ${assetsGrowth >= 0 ? 'growth-positive' : 'growth-negative'}">
                        ${assetsGrowth >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(assetsGrowth).toFixed(1)}%
                    </div>
                </div>
                
                <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                    <div class="text-sm mb-1" style="color: var(--text-secondary);">×”×ª×—×™×™×‘×•×™×•×ª ${periodLabel}</div>
                    <div class="text-xl font-bold mb-2">${formatCurrency(currentLiabilities)}</div>
                    <div class="growth-badge ${liabilitiesGrowth <= 0 ? 'growth-positive' : 'growth-negative'}">
                        ${liabilitiesGrowth >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(liabilitiesGrowth).toFixed(1)}%
                    </div>
                </div>
                
                <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                    <div class="text-sm mb-1" style="color: var(--text-secondary);">×©×•×•×™ × ×§×™ ${periodLabel}</div>
                    <div class="text-xl font-bold mb-2">${formatCurrency(netWorth)}</div>
                    <div class="growth-badge ${netWorthGrowth >= 0 ? 'growth-positive' : 'growth-negative'}">
                        ${netWorthGrowth >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(netWorthGrowth).toFixed(1)}%
                    </div>
                </div>
                
                <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                    <div class="text-sm mb-1" style="color: var(--text-secondary);">×”×›× ×¡×” ×—×•×“×©×™×ª</div>
                    <div class="text-xl font-bold mb-2">${formatCurrency(totals.income)}</div>
                    <div class="growth-badge ${incomeGrowth >= 0 ? 'growth-positive' : 'growth-negative'}">
                        ${incomeGrowth >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(incomeGrowth).toFixed(1)}%
                    </div>
                </div>
            `;
        }

        /* ==========================================
           UI UPDATES
        ========================================== */
        
        function updateDashboard() {
            const totals = calculateTotals();
            
            document.getElementById('totalIncome').textContent = formatCurrency(totals.income);
            document.getElementById('totalExpense').textContent = formatCurrency(totals.expense);
            
            // Handle deficit display (Option B)
            const deficitWarning = document.getElementById('deficitWarning');
            const deficitAmount = document.getElementById('deficitAmount');
            
            if (totals.savings < 0) {
                document.getElementById('totalSavings').textContent = 'â‚ª0';
                deficitWarning.classList.remove('hidden');
                deficitAmount.textContent = formatCurrency(Math.abs(totals.savings));
            } else {
                document.getElementById('totalSavings').textContent = formatCurrency(totals.savings);
                deficitWarning.classList.add('hidden');
            }
            
            document.getElementById('savingsPercent').textContent = totals.savingsPercent.toFixed(1) + '%';
            
            updateAssetsCards();
            updateGrowthAnalysis();
            
            renderTransactionList('income');
            renderTransactionList('expense');
            
            updateGaugeChart(totals.savingsPercent);
            updateExpenseChart();
            updateIncomeChart();
            updateTrendChart();
            updateNetWorthChart();

            const financialHealth = evaluateFinancialHealth(totals);
            renderFinancialHealth(financialHealth);

            updateCashFlowForecastChart();
            renderRecurringTransactions();

            generateInsights();

            setTimeout(() => {
                initializeDragAndDrop();
            }, 100);
        }

        function updateAssetsCards() {
            const currentAssets = getCurrentAssets();
            const currentLiabilities = getCurrentLiabilities();
            const netWorth = currentAssets - currentLiabilities;
            
            const assetsCount = detailedAssets[currentMonth]?.assets?.length || 0;
            const liabilitiesCount = detailedAssets[currentMonth]?.liabilities?.length || 0;
            
            const lastMonth = getDateMonthsAgo(1);
            const lastMonthData = detailedAssets[lastMonth];
            let lastMonthAssets = 0;
            let lastMonthLiabilities = 0;
            
            if (lastMonthData) {
                lastMonthAssets = lastMonthData.assets?.reduce((sum, item) => sum + item.amount, 0) || 0;
                lastMonthLiabilities = lastMonthData.liabilities?.reduce((sum, item) => sum + item.amount, 0) || 0;
            }
            
            const assetsChange = calculateGrowth(currentAssets, lastMonthAssets);
            const liabilitiesChange = calculateGrowth(currentLiabilities, lastMonthLiabilities);
            const netWorthChange = calculateGrowth(netWorth, lastMonthAssets - lastMonthLiabilities);
            
            document.getElementById('totalAssets').textContent = formatCurrency(currentAssets);
            document.getElementById('totalLiabilities').textContent = formatCurrency(currentLiabilities);
            document.getElementById('netWorth').textContent = formatCurrency(netWorth);
            
            document.getElementById('assetsCount').textContent = `${assetsCount} ×¤×¨×™×˜×™×`;
            document.getElementById('liabilitiesCount').textContent = `${liabilitiesCount} ×¤×¨×™×˜×™×`;
            
            document.getElementById('assetsChange').innerHTML = `${assetsChange >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(assetsChange).toFixed(1)}%`;
            document.getElementById('liabilitiesChange').innerHTML = `${liabilitiesChange >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(liabilitiesChange).toFixed(1)}%`;
            document.getElementById('netWorthChange').innerHTML = `${netWorthChange >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(netWorthChange).toFixed(1)}%`;
        }

        /* ==========================================
           COPY PREVIOUS MONTH BALANCES
        ========================================== */
        
        function copyPreviousMonthBalances() {
            try {
                const previousMonth = getDateMonthsAgo(1);
                console.log('Copying from previous month:', previousMonth);
                console.log('Current month:', currentMonth);
                
                const previousData = detailedAssets[previousMonth];
                console.log('Previous month data:', previousData);
                
                if (!previousData || (!previousData.assets?.length && !previousData.liabilities?.length)) {
                    showToast('××™×Ÿ × ×ª×•× ×™ ×—×•×“×© ×§×•×“× ×œ×”×¢×ª×§×”', false);
                    return;
                }
                
                const assetsCount = previousData.assets?.length || 0;
                const liabilitiesCount = previousData.liabilities?.length || 0;
                const confirmMessage = `×”×× ×œ×”×¢×ª×™×§ ${assetsCount} × ×›×¡×™× ×•-${liabilitiesCount} ×”×ª×—×™×™×‘×•×™×•×ª ××—×•×“×© ${previousMonth}?
×¤×¢×•×œ×” ×–×• ×ª×—×œ×™×£ ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™× ×‘×—×•×“×© ${currentMonth}.`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // Deep clone previous month's data
                detailedAssets[currentMonth] = {
                    assets: JSON.parse(JSON.stringify(previousData.assets || [])),
                    liabilities: JSON.parse(JSON.stringify(previousData.liabilities || []))
                };
                
                console.log('Data copied successfully:', detailedAssets[currentMonth]);
                
                saveDetailedAssets();
                
                // Refresh the current view
                const currentType = document.getElementById('assetItemType').value;
                renderAssetItems(currentType);
                updateDashboard();
                
                // Show success message with clear month names
                const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
                const [prevYear, prevMonth] = previousMonth.split('-');
                const [currYear, currMonth] = currentMonth.split('-');
                const prevMonthName = monthNames[parseInt(prevMonth) - 1];
                const currMonthName = monthNames[parseInt(currMonth) - 1];
                
                showToast(`âœ“ ×”×•×¢×ª×§ ×-${prevMonthName} ${prevYear} ×œ-${currMonthName} ${currYear}: ${assetsCount} × ×›×¡×™× + ${liabilitiesCount} ×”×ª×—×™×™×‘×•×™×•×ª`, false);
            } catch (error) {
                console.error('Copy error:', error);
                showToast('×©×’×™××” ×‘×”×¢×ª×§×ª × ×ª×•× ×™×: ' + error.message, false);
            }
        }

        /* ==========================================
           FINANCIAL RATIOS FUNCTIONS
        ========================================== */
        
        let ratiosCharts = {};
        
        function calculateFinancialRatios() {
            const assets = getCurrentAssets();
            const liabilities = getCurrentLiabilities();
            const totals = calculateTotals();

            // Calculate monthly debt payments (expenses in debt categories)
            const debtCategories = ['××©×›× ×ª×', '×”×œ×•×•××ª ×¨×›×‘', '×”×œ×•×•××” ××™×©×™×ª', '×›×¨×˜×™×¡ ××©×¨××™', '××¡×’×¨×ª ××©×¨××™'];
            const monthlyDebtPayments = getMonthTransactions()
                .filter(t => t.type === 'expense' && debtCategories.includes(t.category))
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            // Calculate ratios
            const ratios = {
                liquidity: liabilities > 0 ? (assets / liabilities) : (assets > 0 ? 999 : 1),
                leverage: assets > 0 ? (liabilities / assets) : 0,
                debtToIncome: totals.income > 0 ? (monthlyDebtPayments / totals.income) : 0,
                savingsRatio: totals.income > 0 ? (Math.max(totals.savings, 0) / totals.income) : 0,
                profitability: totals.income > 0 ? (totals.savings / totals.income) : 0,
                netWorth: assets - liabilities
            };
            
            return ratios;
        }

        /* ==========================================
           FINANCIAL HEALTH SCORE & SUMMARY
        ========================================== */

        function evaluateFinancialHealth(totals) {
            const ratios = calculateFinancialRatios();
            const assets = getCurrentAssets();
            const liabilities = getCurrentLiabilities();
            const netWorth = assets - liabilities;
            const emergencyCoverage = totals.expense > 0
                ? (assets / Math.max(totals.expense, 1))
                : (assets > 0 ? 12 : 0);

            const netWorthHistory = [];
            for (let i = 5; i >= 0; i--) {
                const monthKey = getDateMonthsAgo(i);
                const monthData = detailedAssets[monthKey];
                if (monthData) {
                    const monthAssets = monthData.assets?.reduce((sum, item) => sum + item.amount, 0) || 0;
                    const monthLiabilities = monthData.liabilities?.reduce((sum, item) => sum + item.amount, 0) || 0;
                    netWorthHistory.push(monthAssets - monthLiabilities);
                } else {
                    netWorthHistory.push(0);
                }
            }

            const netWorthChange = netWorthHistory.length > 1
                ? netWorthHistory[netWorthHistory.length - 1] - netWorthHistory[0]
                : 0;
            const baseNetWorth = netWorthHistory.length > 0
                ? Math.max(Math.abs(netWorthHistory[0]), 1)
                : Math.max(Math.abs(netWorth), 1);
            const netWorthTrendScore = clamp(50 + (netWorthChange / baseNetWorth) * 100, 0, 100);

            const savingsScore = clamp((totals.savingsPercent / 20) * 100, 0, 100);
            const liquidityScore = clamp((Math.min(ratios.liquidity, 3) / 3) * 100, 0, 100);
            const debtScore = clamp(100 - (ratios.debtToIncome * 100), 0, 100);
            const emergencyScore = clamp((Math.min(emergencyCoverage, 9) / 6) * 100, 0, 100);

            const weightedScore =
                (savingsScore * 0.25) +
                (debtScore * 0.2) +
                (liquidityScore * 0.2) +
                (emergencyScore * 0.15) +
                (netWorthTrendScore * 0.2);

            const score = Math.round(clamp(weightedScore, 0, 100));

            let grade;
            if (score >= 85) {
                grade = { label: '××¦×•×™×Ÿ', color: 'var(--income-color)' };
            } else if (score >= 70) {
                grade = { label: '×—×–×§', color: 'var(--savings-color)' };
            } else if (score >= 55) {
                grade = { label: '×‘×™× ×•× ×™', color: 'var(--warning-color)' };
            } else {
                grade = { label: '×“×•×¨×© ×˜×™×¤×•×œ', color: 'var(--expense-color)' };
            }

            const summaryParts = [
                `×—×™×¡×›×•×Ÿ ×©×œ ${totals.savingsPercent.toFixed(1)}% ××”×”×›× ×¡×”`,
                `×™×—×¡ ×—×•×‘ ×œ×”×›× ×¡×” ${(ratios.debtToIncome * 100).toFixed(1)}%`,
                `×›×™×¡×•×™ ×—×™×¨×•× ×©×œ ${emergencyCoverage.toFixed(1)} ×—×•×“×©×™ ×”×•×¦××•×ª`
            ];

            const focus = [];
            if (totals.savingsPercent < 20) {
                focus.push({
                    icon: 'ğŸ’¡',
                    text: `×”×’×“×œ ××ª ×©×™×¢×•×¨ ×”×—×™×¡×›×•×Ÿ ×‘-${(20 - totals.savingsPercent).toFixed(1)}% ×›×“×™ ×œ×¢××•×“ ×‘×™×¢×“.`
                });
            }
            if (ratios.debtToIncome > 0.36) {
                focus.push({
                    icon: 'ğŸ“‰',
                    text: '×™×—×¡ ×”×—×•×‘ ×œ×”×›× ×¡×” ×’×‘×•×”, ×©×§×•×œ ×œ×¦××¦× ×”×œ×•×•××•×ª ××• ×œ×”×¤×—×™×ª ×ª×©×œ×•××™× ×—×•×“×©×™×™×.'
                });
            }
            if (ratios.liquidity < 1.2) {
                focus.push({
                    icon: 'ğŸ›¡ï¸',
                    text: '×—×–×§ ××ª ×”× ×–×™×œ×•×ª ×‘×××¦×¢×•×ª ×”×’×“×œ×ª ×¨×›×™×‘ ××–×•××Ÿ ××• ×§×¨×Ÿ ×—×™×¨×•×.'
                });
            }
            if (emergencyCoverage < 3) {
                focus.push({
                    icon: 'ğŸš‘',
                    text: '×‘× ×” ×§×¨×Ÿ ×—×™×¨×•× ×©×ª×›×¡×” ×œ×¤×—×•×ª 3 ×—×•×“×©×™ ×”×•×¦××•×ª ×©×•×˜×¤×•×ª.'
                });
            }
            if (netWorthChange < 0) {
                focus.push({
                    icon: 'ğŸ“Š',
                    text: '×”×©×•×•×™ ×”× ×§×™ ×‘×™×¨×™×“×”, ×‘×“×•×§ ×”×•×¦××•×ª ×—×¨×™×’×•×ª ××• ×ª×¤×§×•×“ ×”×©×§×¢×•×ª.'
                });
            }
            if (!focus.length) {
                focus.push({
                    icon: 'âœ…',
                    text: '××¢×•×œ×”! ×”××©×š ×œ×©××•×¨ ×¢×œ ×”×”×¨×’×œ×™× ×”×˜×•×‘×™× ×•×—×¤×© ×”×–×“×× ×•×™×•×ª ×œ×”×©×§×¢×”.'
                });
            }

            return {
                score,
                grade,
                summary: summaryParts.join(' Â· '),
                focus,
                goalProgress: clamp(totals.goalPercent, 0, 150),
                savingsPercent: totals.savingsPercent,
                debtToIncome: ratios.debtToIncome,
                emergencyCoverage,
                netWorthChange
            };
        }

        function renderFinancialHealth(health) {
            const scoreEl = document.getElementById('financialHealthScore');
            if (scoreEl) {
                scoreEl.textContent = health.score;
            }

            const gradeEl = document.getElementById('financialHealthGrade');
            if (gradeEl) {
                gradeEl.textContent = health.grade.label;
                gradeEl.style.color = health.grade.color;
            }

            const circleEl = document.getElementById('financialHealthScoreCircle');
            if (circleEl) {
                const angle = Math.max(6, health.score * 3.6);
                circleEl.style.background = `conic-gradient(${health.grade.color} ${angle}deg, var(--bg-tertiary) ${angle}deg)`;
            }

            const summaryEl = document.getElementById('financialHealthSummary');
            if (summaryEl) {
                summaryEl.textContent = health.summary;
            }

            const focusList = document.getElementById('financialFocusList');
            if (focusList) {
                focusList.innerHTML = health.focus.map(item => `
                    <div class="health-focus-item">
                        <span>${item.icon}</span>
                        <span>${item.text}</span>
                    </div>
                `).join('');
            }

            const progressBar = document.getElementById('financialHealthProgress');
            if (progressBar) {
                const progressValue = clamp(health.goalProgress, 0, 130);
                progressBar.style.width = Math.min(progressValue, 100) + '%';
                progressBar.style.background = `linear-gradient(90deg, ${health.grade.color}, var(--asset-color))`;
            }

            const progressLabel = document.getElementById('financialHealthProgressLabel');
            if (progressLabel) {
                progressLabel.textContent = `${Math.round(clamp(health.goalProgress, 0, 130))}%`;
            }
        }

        function getRatioStatus(ratio, value) {
            const thresholds = {
                liquidity: { good: 1.5, warning: 1.0 },
                leverage: { good: 0.5, warning: 0.7 },
                debtToIncome: { good: 0.36, warning: 0.43 },
                savingsRatio: { good: 0.20, warning: 0.10 },
                profitability: { good: 0.15, warning: 0.05 }
            };
            
            if (!thresholds[ratio]) return 'neutral';
            
            if (ratio === 'liquidity') {
                if (value >= thresholds[ratio].good) return 'good';
                if (value >= thresholds[ratio].warning) return 'warning';
                return 'bad';
            } else {
                if (value <= thresholds[ratio].good) return 'good';
                if (value <= thresholds[ratio].warning) return 'warning';
                return 'bad';
            }
        }
        
        function showFinancialRatiosModal() {
            document.getElementById('financialRatiosModal').classList.remove('hidden');
            document.getElementById('financialRatiosModal').classList.add('flex');
            
            updateFinancialRatiosDisplay();
        }
        
        function closeFinancialRatiosModal() {
            document.getElementById('financialRatiosModal').classList.add('hidden');
            document.getElementById('financialRatiosModal').classList.remove('flex');
            
            // Destroy charts
            if (ratiosCharts.trend1) ratiosCharts.trend1.destroy();
            if (ratiosCharts.trend2) ratiosCharts.trend2.destroy();
        }
        
        function updateFinancialRatiosDisplay() {
            const currentRatios = calculateFinancialRatios();
            
            // Display current ratios
            const ratiosGrid = document.getElementById('currentRatiosGrid');
            
            const ratioCards = [
                {
                    name: '×™×—×¡ × ×–×™×œ×•×ª',
                    value: currentRatios.liquidity,
                    format: (v) => v > 100 ? 'âˆ' : v.toFixed(2),
                    icon: 'ğŸ’§',
                    status: getRatioStatus('liquidity', currentRatios.liquidity)
                },
                {
                    name: '×™×—×¡ ××™× ×•×£',
                    value: currentRatios.leverage,
                    format: (v) => v.toFixed(2),
                    icon: 'âš–ï¸',
                    status: getRatioStatus('leverage', currentRatios.leverage)
                },
                {
                    name: '×—×•×‘ ×œ×”×›× ×¡×”',
                    value: currentRatios.debtToIncome,
                    format: (v) => (v * 100).toFixed(1) + '%',
                    icon: 'ğŸ’³',
                    status: getRatioStatus('debtToIncome', currentRatios.debtToIncome)
                },
                {
                    name: '×™×—×¡ ×—×™×¡×›×•×Ÿ',
                    value: currentRatios.savingsRatio,
                    format: (v) => (v * 100).toFixed(1) + '%',
                    icon: 'ğŸ¯',
                    status: getRatioStatus('savingsRatio', currentRatios.savingsRatio)
                },
                {
                    name: '×¨×•×•×—×™×•×ª',
                    value: currentRatios.profitability,
                    format: (v) => (v * 100).toFixed(1) + '%',
                    icon: 'ğŸ“Š',
                    status: getRatioStatus('profitability', currentRatios.profitability)
                },
                {
                    name: '×©×•×•×™ × ×§×™',
                    value: currentRatios.netWorth,
                    format: (v) => formatCurrency(v),
                    icon: 'ğŸ’°',
                    status: currentRatios.netWorth >= 0 ? 'good' : 'bad'
                }
            ];
            
            const statusColors = {
                good: { bg: '#dcfce7', text: '#166534', border: '#10b981' },
                warning: { bg: '#fef3c7', text: '#92400e', border: '#f59e0b' },
                bad: { bg: '#fee2e2', text: '#991b1b', border: '#ef4444' },
                neutral: { bg: '#f3f4f6', text: '#374151', border: '#9ca3af' }
            };
            
            ratiosGrid.innerHTML = ratioCards.map(card => {
                const colors = statusColors[card.status];
                return `
                    <div class="p-4 rounded-xl transition hover:scale-105" 
                         style="background: ${colors.bg}; border-right: 4px solid ${colors.border};">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-2xl">${card.icon}</span>
                            <span class="font-bold text-sm" style="color: ${colors.text};">${card.name}</span>
                        </div>
                        <div class="text-3xl font-bold mb-1" style="color: ${colors.text};">
                            ${card.format(card.value)}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update trend charts
            updateRatiosTrendCharts();
        }
        
        function updateRatiosTrendCharts() {
            const months = [];
            const liquidityData = [];
            const leverageData = [];
            const savingsRatioData = [];
            const profitabilityData = [];
            
            // Get last 6 months of data
            for (let i = 5; i >= 0; i--) {
                const monthKey = getDateMonthsAgo(i);
                months.push(formatMonthName(monthKey));
                
                // Calculate ratios for each month
                const monthData = detailedAssets[monthKey];
                let assets = 0;
                let liabilities = 0;
                
                if (monthData) {
                    assets = monthData.assets?.reduce((sum, item) => sum + item.amount, 0) || 0;
                    liabilities = monthData.liabilities?.reduce((sum, item) => sum + item.amount, 0) || 0;
                }
                
                const monthTrans = transactions.filter(t => t.month === monthKey);
                const income = monthTrans.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expense = monthTrans.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const savings = income - expense;
                
                const liquidity = liabilities > 0 ? (assets / liabilities) : (assets > 0 ? 10 : 1);
                const leverage = assets > 0 ? (liabilities / assets) : 0;
                const savingsRatio = income > 0 ? (Math.max(savings, 0) / income) : 0;
                const profitability = income > 0 ? (savings / income) : 0;
                
                liquidityData.push(Math.min(liquidity, 10)); // Cap at 10 for better visualization
                leverageData.push(leverage);
                savingsRatioData.push(savingsRatio * 100);
                profitabilityData.push(profitability * 100);
            }
            
            // Chart 1: Liquidity and Leverage
            const ctx1 = document.getElementById('ratiosTrendChart1');
            if (ratiosCharts.trend1) ratiosCharts.trend1.destroy();
            
            ratiosCharts.trend1 = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '×™×—×¡ × ×–×™×œ×•×ª',
                            data: liquidityData,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: '×™×—×¡ ××™× ×•×£',
                            data: leverageData,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                font: { size: 11, weight: '500' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            cornerRadius: 6
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: '× ×–×™×œ×•×ª', color: 'rgb(59, 130, 246)' },
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: '××™× ×•×£', color: 'rgb(239, 68, 68)' },
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { drawOnChartArea: false }
                        },
                        x: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Chart 2: Savings Ratio and Profitability
            const ctx2 = document.getElementById('ratiosTrendChart2');
            if (ratiosCharts.trend2) ratiosCharts.trend2.destroy();
            
            ratiosCharts.trend2 = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '×™×—×¡ ×—×™×¡×›×•×Ÿ (%)',
                            data: savingsRatioData,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '×¨×•×•×—×™×•×ª (%)',
                            data: profitabilityData,
                            borderColor: 'rgb(139, 92, 246)',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                font: { size: 11, weight: '500' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            cornerRadius: 6,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                                callback: function(value) { return value + '%'; }
                            },
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') }
                        },
                        x: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        /* ==========================================
           TABBED TRANSACTION LIST (NEW)
        ========================================== */
        
        function renderTransactionList(type) {
            const container = document.getElementById(type + 'List');
            const tabsContainer = document.getElementById(type + 'TabsContainer');
            let monthTrans = getMonthTransactions().filter(t => t.type === type);
            
            if (monthTrans.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8" style="color: var(--text-secondary);">
                        <div class="text-4xl mb-2">ğŸ“‹</div>
                        <p>××™×Ÿ ×ª× ×•×¢×•×ª ×œ×”×¦×’×”</p>
                    </div>
                `;
                tabsContainer.innerHTML = '';
                return;
            }
            
            // Group transactions by category
            const categorized = {};
            monthTrans.forEach(t => {
                if (!categorized[t.category]) {
                    categorized[t.category] = [];
                }
                categorized[t.category].push(t);
            });
            
            // Create tabs
            const categories = Object.keys(categorized);
            let tabsHTML = '<div class="transaction-tabs">';
            categories.forEach((cat, index) => {
                const count = categorized[cat].length;
                const total = categorized[cat].reduce((sum, t) => sum + parseFloat(t.amount), 0);
                tabsHTML += `
                    <button class="transaction-tab ${index === 0 ? 'active' : ''}" 
                            onclick="switchTransactionTab('${type}', '${cat}')"
                            data-category="${cat}">
                        ${cat} (${count})
                        <span style="display: block; font-size: 0.8rem;">â‚ª${formatCurrency(total).replace('â‚ª','')}</span>
                    </button>
                `;
            });
            tabsHTML += '</div>';
            tabsContainer.innerHTML = tabsHTML;
            
            // Create content for each category
            container.innerHTML = '';
            categories.forEach((cat, index) => {
                const catTrans = categorized[cat].sort((a, b) => new Date(b.date) - new Date(a.date));
                const contentDiv = document.createElement('div');
                contentDiv.className = `transaction-category-content ${index === 0 ? 'active' : ''}`;
                contentDiv.dataset.category = cat;
                
                contentDiv.innerHTML = catTrans.map(t => `
                    <div class="transaction-card p-4 rounded-lg hover:shadow-md transition cursor-move" 
                         style="background: var(--bg-tertiary);"
                         data-transaction-id="${t.id}">
                        <div class="flex items-center gap-3">
                            <div class="drag-handle">
                                <span>â‹®â‹®</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="font-semibold">${t.description}</span>
                                </div>
                                <div class="text-sm" style="color: var(--text-secondary);">${formatDate(t.date)}</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xl font-bold" style="color: var(--${type === 'income' ? 'income' : 'expense'}-color);">
                                    ${formatCurrency(t.amount)}
                                </span>
                                <div class="flex gap-1">
                                    <button onclick="editTransaction(${t.id})" 
                                            class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition">âœï¸</button>
                                    <button onclick="deleteTransaction(${t.id})" 
                                            class="p-2 rounded hover:bg-red-100 dark:hover:bg-red-900 transition">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                container.appendChild(contentDiv);
            });
        }

        // Add new function to handle tab switching
        function switchTransactionTab(type, category) {
            // Update active tab
            const tabs = document.querySelectorAll(`#${type}TabsContainer .transaction-tab`);
            tabs.forEach(tab => {
                if (tab.dataset.category === category) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update active content
            const contents = document.querySelectorAll(`#${type}List .transaction-category-content`);
            contents.forEach(content => {
                if (content.dataset.category === category) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        /* ==========================================
           CATEGORY NAVIGATION FROM CHARTS
        ========================================== */
        
        function filterTransactionsByCategory(type, category) {
            // Switch to the correct transaction type tab
            const tabId = type + 'TabsContainer';
            const listId = type + 'List';
            
            // Find and click the category tab
            const tabs = document.querySelectorAll(`#${tabId} .transaction-tab`);
            const targetTab = Array.from(tabs).find(tab => tab.dataset.category === category);
            
            if (targetTab) {
                // Activate the tab
                switchTransactionTab(type, category);
                
                // Scroll to the transaction list smoothly
                const listContainer = document.getElementById(listId).closest('.rounded-2xl');
                if (listContainer) {
                    listContainer.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                    
                    // Add brief highlight animation to the active content
                    const activeContent = document.querySelector(`#${listId} .transaction-category-content.active`);
                    if (activeContent) {
                        activeContent.style.transition = 'all 0.5s ease';
                        activeContent.style.backgroundColor = 'rgba(59, 130, 246, 0.15)';
                        activeContent.style.transform = 'scale(1.02)';
                        activeContent.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
                        
                        setTimeout(() => {
                            activeContent.style.backgroundColor = '';
                            activeContent.style.transform = '';
                            activeContent.style.boxShadow = '';
                        }, 1000);
                    }
                }
                
                showToast(`Ã°ÂŸ"ÂŠ Ã—ÂÃ—Â¢Ã—'×¨ Ã—ÂœÃ—Â§Ã—Â˜Ã—'Ã—Â•Ã—Â¨Ã—Â™Ã—": ${category}`, false);
            } else {
                showToast(`Ã¢Âš Ã¯Â¸ Ã—ÂœÃ— Ã— Ã—ÂÃ—Â¦Ã—Ã—Â• Ã—ÂªÃ— ×•×¢×•×ª Ã—'Ã—Â§Ã—Â˜Ã—'Ã—Â•Ã—Â¨Ã—Â™Ã—" ${category}`, false);
            }
        }

        /* ==========================================
           MODERNIZED CHARTS WITH GRADIENTS
        ========================================== */
        
        function updateGaugeChart(percent) {
            const ctx = document.getElementById('gaugeChart');
            
            if (charts.gauge) {
                charts.gauge.destroy();
            }
            
            const normalizedPercent = Math.min(percent / 20 * 100, 100);
            
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 200);
            if (percent >= 20) {
                gradient.addColorStop(0, '#10b981');
                gradient.addColorStop(1, '#059669');
            } else if (percent >= 10) {
                gradient.addColorStop(0, '#f59e0b');
                gradient.addColorStop(1, '#d97706');
            } else {
                gradient.addColorStop(0, '#ef4444');
                gradient.addColorStop(1, '#dc2626');
            }
            
            charts.gauge = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [normalizedPercent, 100 - normalizedPercent],
                        backgroundColor: [
                            gradient,
                            'rgba(200, 200, 200, 0.15)'
                        ],
                        borderWidth: 0,
                        borderRadius: 8
                    }]
                },
                options: {
                    cutout: '75%',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1200,
                        easing: 'easeInOutQuart'
                    }
                }
            });
            
            document.getElementById('gaugePercent').textContent = percent.toFixed(1) + '%';
        }

        function updateExpenseChart() {
            const ctx = document.getElementById('expenseChart');
            const expenses = getMonthTransactions().filter(t => t.type === 'expense');
            
            const categoryTotals = {};
            expenses.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseFloat(t.amount);
            });
            
            if (charts.expense) {
                charts.expense.destroy();
            }
            
            const modernColors = [
                'rgba(239, 68, 68, 0.9)', 'rgba(245, 158, 11, 0.9)', 'rgba(234, 179, 8, 0.9)',
                'rgba(132, 204, 22, 0.9)', 'rgba(34, 197, 94, 0.9)', 'rgba(20, 184, 166, 0.9)',
                'rgba(6, 182, 212, 0.9)', 'rgba(59, 130, 246, 0.9)', 'rgba(99, 102, 241, 0.9)',
                'rgba(139, 92, 246, 0.9)', 'rgba(168, 85, 247, 0.9)', 'rgba(217, 70, 239, 0.9)'
            ];
            
            charts.expense = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        data: Object.values(categoryTotals),
                        backgroundColor: modernColors,
                        borderWidth: 2,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-secondary'),
                        hoverOffset: 12,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                font: { size: 11, weight: '500' },
                                padding: 12,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const category = Object.keys(categoryTotals)[index];
                            filterTransactionsByCategory('expense', category);
                        }
                    }
                }
            });
        }

        function updateIncomeChart() {
            const ctx = document.getElementById('incomeChart');
            const incomes = getMonthTransactions().filter(t => t.type === 'income');
            
            const categoryTotals = {};
            incomes.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseFloat(t.amount);
            });
            
            if (charts.income) {
                charts.income.destroy();
            }
            
            const incomeColors = [
                'rgba(16, 185, 129, 0.9)', 'rgba(20, 184, 166, 0.9)', 'rgba(6, 182, 212, 0.9)',
                'rgba(59, 130, 246, 0.9)', 'rgba(99, 102, 241, 0.9)', 'rgba(139, 92, 246, 0.9)',
                'rgba(168, 85, 247, 0.9)', 'rgba(217, 70, 239, 0.9)'
            ];
            
            charts.income = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        data: Object.values(categoryTotals),
                        backgroundColor: incomeColors,
                        borderWidth: 2,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-secondary'),
                        hoverOffset: 12,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                font: { size: 11, weight: '500' },
                                padding: 12,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const category = Object.keys(categoryTotals)[index];
                            filterTransactionsByCategory('expense', category);
                        }
                    }
                }
            });
        }

        function updateTrendChart() {
            const ctx = document.getElementById('trendChart');
            
            const months = [];
            const incomeData = [];
            const expenseData = [];
            
            for (let i = 5; i >= 0; i--) {
                const monthKey = getDateMonthsAgo(i);
                months.push(formatMonthName(monthKey));
                
                const monthTrans = transactions.filter(t => t.month === monthKey);
                const income = monthTrans.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expense = monthTrans.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                incomeData.push(income);
                expenseData.push(expense);
            }
            
            if (charts.trend) {
                charts.trend.destroy();
            }
            
            const ctxGradient = ctx.getContext('2d');
            const incomeGradient = ctxGradient.createLinearGradient(0, 0, 0, 300);
            incomeGradient.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
            incomeGradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');
            
            const expenseGradient = ctxGradient.createLinearGradient(0, 0, 0, 300);
            expenseGradient.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
            expenseGradient.addColorStop(1, 'rgba(239, 68, 68, 0.0)');
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '×”×›× ×¡×•×ª',
                            data: incomeData,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: incomeGradient,
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointBackgroundColor: 'rgb(16, 185, 129)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: '×”×•×¦××•×ª',
                            data: expenseData,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: expenseGradient,
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointBackgroundColor: 'rgb(239, 68, 68)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                font: { size: 12, weight: '500' },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                                font: { size: 11 },
                                callback: function(value) {
                                    return 'â‚ª' + value.toLocaleString('he-IL');
                                }
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                                font: { size: 11 }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function updateNetWorthChart() {
            const ctx = document.getElementById('netWorthChart');

            const months = [];
            const netWorthData = [];
            
            for (let i = 11; i >= 0; i--) {
                const monthKey = getDateMonthsAgo(i);
                months.push(formatMonthName(monthKey));
                
                const monthData = detailedAssets[monthKey];
                if (monthData) {
                    const assets = monthData.assets?.reduce((sum, item) => sum + item.amount, 0) || 0;
                    const liabilities = monthData.liabilities?.reduce((sum, item) => sum + item.amount, 0) || 0;
                    netWorthData.push(assets - liabilities);
                } else {
                    netWorthData.push(0);
                }
            }
            
            if (charts.netWorth) {
                charts.netWorth.destroy();
            }
            
            const ctxGradient = ctx.getContext('2d');
            const gradient = ctxGradient.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(20, 184, 166, 0.4)');
            gradient.addColorStop(1, 'rgba(20, 184, 166, 0.0)');
            
            charts.netWorth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: '×©×•×•×™ × ×§×™',
                        data: netWorthData,
                        borderColor: 'rgb(20, 184, 166)',
                        backgroundColor: gradient,
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointBackgroundColor: 'rgb(20, 184, 166)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                font: { size: 12, weight: '500' },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                                font: { size: 11 },
                                callback: function(value) {
                                    return 'â‚ª' + value.toLocaleString('he-IL');
                                }
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                                font: { size: 11 }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function updateCashFlowForecastChart() {
            const canvas = document.getElementById('cashFlowForecastChart');
            if (!canvas) return;

            const historyMonths = 6;
            const forecastMonths = 3;

            const labels = [];
            const incomeHistory = [];
            const expenseHistory = [];

            for (let i = historyMonths - 1; i >= 0; i--) {
                const monthKey = getDateMonthsAgo(i);
                labels.push(formatMonthName(monthKey));
                const monthTrans = getTransactionsByMonth(monthKey);
                const monthIncome = monthTrans.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const monthExpense = monthTrans.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                incomeHistory.push(monthIncome);
                expenseHistory.push(monthExpense);
            }

            const incomeForecastValues = forecastNextValues(incomeHistory, forecastMonths);
            const expenseForecastValues = forecastNextValues(expenseHistory, forecastMonths);
            const netHistory = incomeHistory.map((value, index) => value - expenseHistory[index]);
            const netForecastValues = incomeForecastValues.map((value, index) => value - expenseForecastValues[index]);

            const futureLabels = [];
            for (let i = 1; i <= forecastMonths; i++) {
                futureLabels.push(formatMonthName(getDateMonthsAhead(i)));
            }

            const allLabels = [...labels, ...futureLabels];

            const incomeActual = [...incomeHistory, ...Array(forecastMonths).fill(null)];
            const incomeForecast = [...Array(historyMonths).fill(null), ...incomeForecastValues];
            const expenseActual = [...expenseHistory, ...Array(forecastMonths).fill(null)];
            const expenseForecast = [...Array(historyMonths).fill(null), ...expenseForecastValues];
            const netActual = [...netHistory, ...Array(forecastMonths).fill(null)];
            const netForecast = [...Array(historyMonths).fill(null), ...netForecastValues];

            if (charts.cashFlowForecast) {
                charts.cashFlowForecast.destroy();
            }

            charts.cashFlowForecast = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [
                        {
                            label: '×”×›× ×¡×•×ª (×”×™×¡×˜×•×¨×™)',
                            data: incomeActual,
                            borderColor: 'rgba(34, 197, 94, 1)',
                            backgroundColor: 'rgba(34, 197, 94, 0.15)',
                            tension: 0.35,
                            borderWidth: 3,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgba(34, 197, 94, 1)'
                        },
                        {
                            label: '×”×›× ×¡×•×ª (×ª×—×–×™×ª)',
                            data: incomeForecast,
                            borderColor: 'rgba(34, 197, 94, 0.7)',
                            borderDash: [6, 6],
                            tension: 0.35,
                            borderWidth: 2,
                            pointRadius: 0,
                            spanGaps: true
                        },
                        {
                            label: '×”×•×¦××•×ª (×”×™×¡×˜×•×¨×™)',
                            data: expenseActual,
                            borderColor: 'rgba(248, 113, 113, 1)',
                            backgroundColor: 'rgba(248, 113, 113, 0.12)',
                            tension: 0.35,
                            borderWidth: 3,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgba(248, 113, 113, 1)'
                        },
                        {
                            label: '×”×•×¦××•×ª (×ª×—×–×™×ª)',
                            data: expenseForecast,
                            borderColor: 'rgba(248, 113, 113, 0.7)',
                            borderDash: [6, 6],
                            tension: 0.35,
                            borderWidth: 2,
                            pointRadius: 0,
                            spanGaps: true
                        },
                        {
                            label: '×ª×–×¨×™× × ×§×™ (×”×™×¡×˜×•×¨×™)',
                            data: netActual,
                            borderColor: 'rgba(14, 165, 233, 1)',
                            tension: 0.35,
                            borderWidth: 2,
                            pointRadius: 3,
                            fill: false
                        },
                        {
                            label: '×ª×–×¨×™× × ×§×™ (×ª×—×–×™×ª)',
                            data: netForecast,
                            borderColor: 'rgba(14, 165, 233, 0.7)',
                            borderDash: [4, 6],
                            tension: 0.35,
                            borderWidth: 2,
                            pointRadius: 0,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                font: { size: 11, weight: '500' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.85)',
                            padding: 12,
                            cornerRadius: 10,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === null || isNaN(value)) return context.dataset.label;
                                    return `${context.dataset.label}: ${formatCurrency(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                                callback: function(value) { return 'â‚ª' + value.toLocaleString('he-IL'); }
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                                maxRotation: 0
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        /* ==========================================
           RECURRING TRANSACTIONS INTELLIGENCE
        ========================================== */

        function detectRecurringTransactions() {
            const lookbackMonths = 6;
            const relevantMonths = new Set();
            for (let i = 0; i < lookbackMonths; i++) {
                relevantMonths.add(getDateMonthsAgo(i));
            }

            const groups = new Map();

            transactions.forEach(transaction => {
                const monthKey = transaction.month || (transaction.date ? transaction.date.slice(0, 7) : null);
                if (!monthKey || !relevantMonths.has(monthKey)) return;

                const rawDescription = (transaction.description || '×œ×œ× ×ª×™××•×¨').trim();
                const key = `${transaction.type}|${rawDescription.toLowerCase()}`;
                if (!groups.has(key)) {
                    groups.set(key, {
                        description: rawDescription,
                        type: transaction.type,
                        months: new Map(),
                        amounts: [],
                        lastDate: transaction.date ? new Date(transaction.date) : null
                    });
                }

                const group = groups.get(key);
                group.amounts.push(parseFloat(transaction.amount));
                group.months.set(monthKey, (group.months.get(monthKey) || 0) + 1);

                if (transaction.date) {
                    const dateObj = new Date(transaction.date);
                    if (!group.lastDate || dateObj > group.lastDate) {
                        group.lastDate = dateObj;
                    }
                }
            });

            const results = [];

            groups.forEach(group => {
                const occurrences = group.months.size;
                if (occurrences < 3) return;

                const total = group.amounts.reduce((sum, value) => sum + value, 0);
                const average = total / group.amounts.length;
                const variability = calculateStdDev(group.amounts);
                const variabilityRatio = average !== 0 ? variability / Math.abs(average) : 0;
                const missedThisMonth = !group.months.has(currentMonth);

                results.push({
                    description: group.description,
                    type: group.type,
                    average,
                    occurrences,
                    frequencyText: `${occurrences} ××ª×•×š ${lookbackMonths} ×—×•×“×©×™×`,
                    variabilityRatio,
                    missedThisMonth,
                    lastSeen: group.lastDate
                });
            });

            results.sort((a, b) => {
                if (a.type === b.type) {
                    return Math.abs(b.average) - Math.abs(a.average);
                }
                return a.type === 'income' ? -1 : 1;
            });

            return results.slice(0, 6);
        }

        function renderRecurringTransactions() {
            const container = document.getElementById('recurringTransactionsList');
            if (!container) return;

            const recurring = detectRecurringTransactions();

            if (recurring.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10" style="color: var(--text-secondary);">
                        <div class="text-3xl mb-2">ğŸŒ±</div>
                        <p>×¢×“×™×™×Ÿ ××™×Ÿ ×“×¤×•×¡×™× ×—×•×–×¨×™× ×‘×¨×•×¨×™× ×‘×—×¦×™ ×”×©× ×” ×”××—×¨×•× ×”</p>
                        <p class="text-sm mt-1">×™×™×‘×•× × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™× ×™×©×¤×¨ ××ª ×”×–×™×”×•×™</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recurring.map(item => {
                const directionClass = item.type === 'income' ? 'recurring-direction-income' : 'recurring-direction-expense';
                const sign = item.type === 'expense' ? '-' : '+';
                const variabilityBadge = item.variabilityRatio > 0.25
                    ? `<span class="recurring-badge" style="color: var(--warning-color);">×©×•× ×•×ª ×’×‘×•×”×”</span>`
                    : `<span class="recurring-badge" style="color: var(--savings-color);">×™×¦×™×‘</span>`;
                const statusBadge = item.missedThisMonth
                    ? `<span class="recurring-badge recurring-missed">×œ× ×”×•×¤×™×¢ ×”×—×•×“×©</span>`
                    : `<span class="recurring-badge" style="color: var(--savings-color);">×‘××¡×œ×•×œ</span>`;
                const lastSeen = item.lastSeen ? item.lastSeen.toLocaleDateString('he-IL', { month: 'short', day: 'numeric' }) : '-';

                return `
                    <div class="recurring-item">
                        <div>
                            <div class="font-semibold text-lg">${item.description}</div>
                            <div class="recurring-meta">
                                <span>${item.frequencyText}</span>
                                <span>× ×¨××” ×œ××—×¨×•× ×”: ${lastSeen}</span>
                                ${variabilityBadge}
                                ${statusBadge}
                            </div>
                        </div>
                        <div class="recurring-amount ${directionClass}">${sign}${formatCurrency(item.average)}</div>
                    </div>
                `;
            }).join('');
        }

        /* ==========================================
           AI INSIGHTS
        ========================================== */
        
        function generateInsights() {
            const container = document.getElementById('insightsContainer');
            const totals = calculateTotals();
            const insights = [];

            const health = evaluateFinancialHealth(totals);
            const healthColor = health.score >= 85 ? 'text-green-600' : health.score >= 70 ? 'text-emerald-600' : health.score >= 55 ? 'text-orange-600' : 'text-red-600';
            insights.push({
                icon: 'ğŸ§ ',
                text: `××“×“ ×”×‘×¨×™××•×ª ×”×¤×™× × ×¡×™×ª ×©×œ×š ×”×•× ${health.score}/100 (${health.grade.label})`,
                color: healthColor
            });

            if (totals.savingsPercent >= 20) {
                insights.push({
                    icon: 'ğŸ‰',
                    text: '××¢×•×œ×”! ×¢×‘×¨×ª ××ª ×™×¢×“ ×”×—×™×¡×›×•×Ÿ ×”×—×•×“×©×™',
                    color: 'text-green-600'
                });
            } else if (totals.savingsPercent >= 10) {
                insights.push({
                    icon: 'ğŸ’ª',
                    text: `×¢×•×“ ${(20 - totals.savingsPercent).toFixed(1)}% ×œ×™×¢×“ ×”×—×™×¡×›×•×Ÿ`,
                    color: 'text-orange-600'
                });
            } else if (totals.savingsPercent > 0) {
                insights.push({
                    icon: 'âš ï¸',
                    text: '× ×¡×” ×œ×”×’×“×™×œ ××ª ×©×™×¢×•×¨ ×”×—×™×¡×›×•×Ÿ ×”×—×•×“×©×™',
                    color: 'text-red-600'
                });
            }
            
            const netWorth = getCurrentAssets() - getCurrentLiabilities();
            if (netWorth > 0) {
                insights.push({
                    icon: 'ğŸ“Š',
                    text: `×”×©×•×•×™ ×”× ×§×™ ×©×œ×š: ${formatCurrency(netWorth)}`,
                    color: 'text-green-600'
                });
            } else if (netWorth < 0) {
                insights.push({
                    icon: 'ğŸ“‰',
                    text: `×©×•×•×™ × ×§×™ ×©×œ×™×œ×™: ${formatCurrency(Math.abs(netWorth))}`,
                    color: 'text-red-600'
                });
            }
            
            const lastMonthTrans = transactions.filter(t => t.month === getDateMonthsAgo(1));
            const lastMonthExpense = lastMonthTrans.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            if (lastMonthExpense > 0) {
                const change = ((totals.expense - lastMonthExpense) / lastMonthExpense * 100);
                if (Math.abs(change) > 5) {
                    insights.push({
                        icon: change > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰',
                        text: `×”×”×•×¦××•×ª ${change > 0 ? '×¢×œ×•' : '×™×¨×“×•'} ×‘-${Math.abs(change).toFixed(1)}% ×œ×¢×•××ª ×—×•×“×© ×©×¢×‘×¨`,
                        color: change > 0 ? 'text-red-600' : 'text-green-600'
                    });
                }
            }
            
            const expenses = getMonthTransactions().filter(t => t.type === 'expense');
            if (expenses.length > 0) {
                const categoryTotals = {};
                expenses.forEach(t => {
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseFloat(t.amount);
                });
                const topCategory = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];
                insights.push({
                    icon: 'ğŸ“‹',
                    text: `×”×§×˜×’×•×¨×™×” ×¢× ×”×”×•×¦××•×ª ×”×’×‘×•×”×•×ª: ${topCategory[0]} (${formatCurrency(topCategory[1])})`,
                    color: 'text-blue-600'
                });
            }
            
            if (totals.savings > 5000) {
                insights.push({
                    icon: 'ğŸ¯',
                    text: '×™×© ×œ×š ×¡×›×•× × ××” ×œ×—×™×¡×›×•×Ÿ - ×©×§×•×œ ×”×©×§×¢×”',
                    color: 'text-blue-600'
                });
            }
            
            container.innerHTML = insights.map(insight => `
                <div class="flex items-start gap-3 p-3 rounded-lg" style="background: var(--bg-tertiary);">
                    <span class="text-2xl">${insight.icon}</span>
                    <p class="text-sm ${insight.color}">${insight.text}</p>
                </div>
            `).join('');
        }

        /* ==========================================
           EXCEL EXPORT
        ========================================== */
        
        function exportToExcel() {
            const monthTrans = getMonthTransactions();
            
            if (monthTrans.length === 0 && getCurrentAssets() === 0 && getCurrentLiabilities() === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×');
                return;
            }
            
            const transData = monthTrans.map(t => ({
                '×ª××¨×™×š': t.date,
                '×¡×•×’': t.type === 'income' ? '×”×›× ×¡×”' : '×”×•×¦××”',
                '×ª×™××•×¨': t.description,
                '×§×˜×’×•×¨×™×”': t.category,
                '×¡×›×•×': t.type === 'income' ? t.amount : -t.amount
            }));
            
            const totals = calculateTotals();
            transData.push({});
            transData.push({
                '×ª××¨×™×š': '',
                '×¡×•×’': '×¡×™×›×•×',
                '×ª×™××•×¨': '×¡×”"×› ×”×›× ×¡×•×ª',
                '×§×˜×’×•×¨×™×”': '',
                '×¡×›×•×': totals.income
            });
            transData.push({
                '×ª××¨×™×š': '',
                '×¡×•×’': '×¡×™×›×•×',
                '×ª×™××•×¨': '×¡×”"×› ×”×•×¦××•×ª',
                '×§×˜×’×•×¨×™×”': '',
                '×¡×›×•×': -totals.expense
            });
            transData.push({
                '×ª××¨×™×š': '',
                '×¡×•×’': '×¡×™×›×•×',
                '×ª×™××•×¨': '×™×ª×¨×”',
                '×§×˜×’×•×¨×™×”': '',
                '×¡×›×•×': totals.savings
            });
            
            const ws = XLSX.utils.json_to_sheet(transData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "×ª× ×•×¢×•×ª");
            
            const assetsData = [];
            const assets = detailedAssets[currentMonth]?.assets || [];
            const liabilities = detailedAssets[currentMonth]?.liabilities || [];
            
            assets.forEach(item => {
                assetsData.push({
                    '×¡×•×’': '× ×›×¡',
                    '×ª×™××•×¨': item.description,
                    '×§×˜×’×•×¨×™×”': item.category,
                    '×¡×›×•×': item.amount
                });
            });
            
            liabilities.forEach(item => {
                assetsData.push({
                    '×¡×•×’': '×”×ª×—×™×™×‘×•×ª',
                    '×ª×™××•×¨': item.description,
                    '×§×˜×’×•×¨×™×”': item.category,
                    '×¡×›×•×': -item.amount
                });
            });
            
            assetsData.push({});
            assetsData.push({
                '×¡×•×’': '×¡×™×›×•×',
                '×ª×™××•×¨': '×¡×”"×› × ×›×¡×™×',
                '×§×˜×’×•×¨×™×”': '',
                '×¡×›×•×': getCurrentAssets()
            });
            assetsData.push({
                '×¡×•×’': '×¡×™×›×•×',
                '×ª×™××•×¨': '×¡×”"×› ×”×ª×—×™×™×‘×•×™×•×ª',
                '×§×˜×’×•×¨×™×”': '',
                '×¡×›×•×': -getCurrentLiabilities()
            });
            assetsData.push({
                '×¡×•×’': '×¡×™×›×•×',
                '×ª×™××•×¨': '×©×•×•×™ × ×§×™',
                '×§×˜×’×•×¨×™×”': '',
                '×¡×›×•×': getCurrentAssets() - getCurrentLiabilities()
            });
            
            const assetsWs = XLSX.utils.json_to_sheet(assetsData);
            XLSX.utils.book_append_sheet(wb, assetsWs, "×××–×Ÿ");
            
            XLSX.writeFile(wb, `finance_${AUTH_SYSTEM.currentUser.username}_${currentMonth}.xlsx`);
            showToast('×”×§×•×‘×¥ ×™×•×¦× ×‘×”×¦×œ×—×”', false);
        }

        /* ==========================================
           UTILITY FUNCTIONS
        ========================================== */
        

        /* ==========================================
           EXCEL IMPORT FUNCTIONALITY
        ========================================== */
        
        let pendingImportTransactions = [];
        let skippedDuplicates = 0;

        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            document.getElementById('importModal').classList.add('flex');
            document.getElementById('importStep1').classList.remove('hidden');
            document.getElementById('importStep2').classList.add('hidden');
            document.getElementById('importProcessing').classList.add('hidden');
            document.getElementById('excelFileInput').value = ''; // Reset file input
            pendingImportTransactions = [];
            skippedDuplicates = 0;
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('importModal').classList.remove('flex');
            pendingImportTransactions = [];
            skippedDuplicates = 0;
        }

        async function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Show file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('fileInfo').classList.remove('hidden');
            
            // Show processing
            setTimeout(() => {
                document.getElementById('importStep1').classList.add('hidden');
                document.getElementById('importProcessing').classList.remove('hidden');
            }, 300);
            
            try {
                // Read file
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                
                // Get first sheet
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(worksheet, { defval: '', raw: false });
                
                console.log(`Read ${rows.length} rows from Excel`);
                
                // Process transactions
                const processedTransactions = processExcelRows(rows);
                
                if (processedTransactions.length === 0) {
                    showToast('âŒ ×œ× × ××¦××• ×ª× ×•×¢×•×ª ×ª×§×™× ×•×ª ×‘×§×•×‘×¥. ×•×“× ×©×”×§×•×‘×¥ ××›×™×œ ×¢××•×“×•×ª ×ª××¨×™×š, ×ª×™××•×¨ ×•×¡×›×•×', false);
                    closeImportModal();
                    return;
                }
                
                // Store for confirmation
                pendingImportTransactions = processedTransactions;
                
                // Calculate statistics
                const incomeCount = processedTransactions.filter(t => t.type === 'income').length;
                const expenseCount = processedTransactions.filter(t => t.type === 'expense').length;
                const highConfCount = processedTransactions.filter(t => t.confidence >= 80).length;
                const lowConfCount = processedTransactions.filter(t => t.confidence < 80).length;
                
                // Show preview
                showImportPreview(processedTransactions);
                
                // Update statistics
                document.getElementById('transactionCount').textContent = processedTransactions.length;
                document.getElementById('duplicateCount').textContent = skippedDuplicates;
                document.getElementById('incomeCount').textContent = incomeCount;
                document.getElementById('expenseCount').textContent = expenseCount;
                document.getElementById('highConfCount').textContent = highConfCount;
                document.getElementById('lowConfCount').textContent = lowConfCount;
                
                // Update UI
                document.getElementById('importProcessing').classList.add('hidden');
                document.getElementById('importStep2').classList.remove('hidden');
                
            } catch (error) {
                console.error('Import error:', error);
                showToast('âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥: ' + error.message + '. ×•×“× ×©×”×§×•×‘×¥ ×”×•× Excel ×ª×§×™×Ÿ', false);
                closeImportModal();
            }
        }

        function processExcelRows(rows) {
            const processed = [];
            const existingHashes = new Set(
                transactions.map(t => `${t.date}-${t.description.toLowerCase().trim()}-${Math.round(t.amount * 100)}`)
            );
            
            skippedDuplicates = 0;
            
            for (let rowIndex = 0; rowIndex < rows.length; rowIndex++) {
                try {
                    const row = rows[rowIndex];
                    
                    // Parse transaction from row
                    const transaction = parseExcelRow(row);
                    
                    if (!transaction) {
                        continue; // Skip invalid rows
                    }
                    
                    // Check for duplicates
                    const hash = `${transaction.date}-${transaction.description.toLowerCase().trim()}-${Math.round(transaction.amount * 100)}`;
                    if (existingHashes.has(hash)) {
                        skippedDuplicates++;
                        continue;
                    }
                    
                    // Auto-categorize
                    transaction.category = detectCategory(transaction.description, transaction.type);
                    
                    // Calculate confidence score
                    transaction.confidence = calculateConfidence(transaction);
                    
                    processed.push(transaction);
                    
                } catch (error) {
                    console.warn(`Skipping row ${rowIndex + 1}:`, error.message);
                }
            }
            
            console.log(`Processed ${processed.length} transactions, skipped ${skippedDuplicates} duplicates`);
            return processed;
        }

        function parseExcelRow(row) {
            // Get all keys
            const keys = Object.keys(row);
            
            // Try to find date column
            const dateKey = keys.find(k => 
                k.includes('×ª××¨×™×š') || 
                k.includes('Date') || 
                k.includes('date') ||
                k.includes('×™×•×')
            );
            
            // Try to find description column
            const descKey = keys.find(k => 
                k.includes('×ª×™××•×¨') || 
                k.includes('×¤×¨×˜×™') || 
                k.includes('×ª× ×•×¢×”') || 
                k.includes('Description') ||
                k.includes('description') ||
                k.includes('×¤×™×¨×•×˜') ||
                k.includes('×”×¢×¨×”')
            );
            
            // Try to find amount column
            const amountKey = keys.find(k => 
                k.includes('×¡×›×•×') || 
                k.includes('×—×™×•×‘') || 
                k.includes('×–×›×•×™') ||
                k.includes('Amount') ||
                k.includes('amount') ||
                k.includes('Sum') ||
                k.includes('Value')
            );
            
            if (!dateKey || !descKey || !amountKey) {
                return null;
            }
            
            // Parse date
            const dateValue = row[dateKey];
            let date;
            
            if (!dateValue || dateValue === '') {
                return null;
            }
            
            if (typeof dateValue === 'number') {
                // Excel serial date
                const excelEpoch = new Date(1899, 11, 30);
                const jsDate = new Date(excelEpoch.getTime() + dateValue * 86400000);
                date = jsDate.toISOString().split('T')[0];
            } else {
                // Try parsing string
                date = parseIsraeliBankDate(String(dateValue));
            }
            
            if (!date || date === 'Invalid Date') {
                return null;
            }
            
            // Parse amount
            let amount = row[amountKey];
            
            if (amount === '' || amount === null || amount === undefined) {
                return null;
            }
            
            if (typeof amount === 'string') {
                // Remove currency symbols, commas, and whitespace
                amount = amount.replace(/[â‚ª$â‚¬Â£,\s]/g, '');
                // Handle Hebrew minus sign and parentheses for negative
                amount = amount.replace(/[â€ª-â€®()]/g, '');
                amount = parseFloat(amount);
            } else {
                amount = parseFloat(amount);
            }
            
            if (isNaN(amount) || amount === 0) {
                return null;
            }
            
            // Determine type based on amount sign
            const type = amount > 0 ? 'income' : 'expense';
            amount = Math.abs(amount);
            
            // Get description
            let description = String(row[descKey] || '').trim();
            
            if (!description || description === '' || description === 'undefined') {
                return null;
            }
            
            // Clean description
            description = description.replace(/\s+/g, ' ').substring(0, 200);
            
            return {
                date,
                description,
                amount,
                type,
                month: date.substring(0, 7) // YYYY-MM
            };
        }

        function parseIsraeliBankDate(dateStr) {
            if (!dateStr) return null;
            
            const str = String(dateStr).trim();
            
            // Try DD/MM/YYYY
            let match = str.match(/(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{4})/);
            if (match) {
                const [, day, month, year] = match;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            
            // Try DD/MM/YY
            match = str.match(/(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{2})$/);
            if (match) {
                const [, day, month, year] = match;
                const fullYear = parseInt(year) > 50 ? `19${year}` : `20${year}`;
                return `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            
            // Try YYYY-MM-DD
            match = str.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
            if (match) {
                const [, year, month, day] = match;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            
            return null;
        }

        function detectCategory(description, type) {
            const lowerDesc = description.toLowerCase();
            const categories = DEFAULT_CATEGORIES[type];
            
            // Try exact keyword match first
            for (const [category, keywords] of Object.entries(categories)) {
                for (const keyword of keywords) {
                    if (keyword && lowerDesc.includes(keyword.toLowerCase())) {
                        return category;
                    }
                }
            }
            
            // Enhanced merchant detection (Hebrew + English)
            const merchantPatterns = {
                'income': {
                    '××©×›×•×¨×ª': ['××©×›×•×¨×ª', '×©×›×¨', '×ª×œ×•×©', 'salary', 'wage', '×”×¢×‘×¨×”'],
                    '×”×©×§×¢×•×ª': ['×“×™×‘×™×“× ×“', '×¨×™×‘×™×ª', '×¨×•×•×—', 'dividend', 'interest', 'profit'],
                    '××—×¨': []
                },
                'expense': {
                    '××–×•×Ÿ': ['×¡×•×¤×¨', '×©×•×¤×¨×¡×œ', '×¨××™ ×œ×•×™', '××—×¡× ×™', '×™×™× ×•×ª', 'market', 'grocery', 'food', '×¤×¨×™', '×™×¨×§×•×ª', 'victori', '×—×¦×™ ×—×™× ×'],
                    '×ª×—×‘×•×¨×”': ['×“×œ×§', '×ª×“×œ×•×§', 'paz', '×¡×•× ×•×œ', '×“×•×¨ ××œ×•×Ÿ', 'ten', '×—× ×™×”', 'parking', 'uber', 'gett', '×ª×—×‘×•×¨×”', '×¨×›×‘×ª', '××•×˜×•×‘×•×¡'],
                    '×“×™×•×¨': ['××¨× ×•× ×”', '×—×©××œ', '××™×', '×’×–', 'rent', 'ikea', '×©×›×™×¨×•×ª', '××©×›× ×ª×', '×•×¢×“ ×‘×™×ª'],
                    '×‘×™×“×•×¨': ['× ×˜×¤×œ×™×§×¡', '×¡×¤×•×˜×™×¤×™×™', 'netflix', 'spotify', 'cinema', 'yes', 'hot', '×¡×¨×˜', '×”×•×¤×¢×”', '×ª×™××˜×¨×•×Ÿ'],
                    '×‘×¨×™××•×ª': ['×¡×•×¤×¨-×¤××¨×', '× ×™×•-×¤××¨×', 'pharmacy', 'doctor', '×¨×•×¤×', '×§×•×¤×”', '×¨×¤×•××”', '×©×™× ×™×™×', '××©×§×¤×™×™×'],
                    '×§× ×™×•×ª': ['×–××¨×”', 'h&m', 'castro', 'fox', 'golf', '×§× ×™×•×Ÿ', 'mall', '××•×¤× ×”', '×‘×’×“×™×'],
                    '×—×©×‘×•× ×•×ª': ['×—×©××œ', '××™×', '×’×–', '××™× ×˜×¨× ×˜', '×˜×œ×¤×•×Ÿ', 'bezeq', 'hot', 'cellcom', 'pelephone', 'partner'],
                    '××—×¨': []
                }
            };
            
            const patterns = merchantPatterns[type] || {};
            for (const [category, keywords] of Object.entries(patterns)) {
                for (const pattern of keywords) {
                    if (pattern && lowerDesc.includes(pattern)) {
                        return category;
                    }
                }
            }
            
            // Fallback to "××—×¨"
            return '××—×¨';
        }

        function calculateConfidence(transaction) {
            const lowerDesc = transaction.description.toLowerCase();
            const categories = DEFAULT_CATEGORIES[transaction.type];
            const keywords = categories[transaction.category] || [];
            
            // Check if category exists in custom categories
            const customCats = customCategories[transaction.type] || [];
            if (customCats.includes(transaction.category)) {
                return 60; // Custom category, medium confidence
            }
            
            // Exact description match = 100%
            for (const keyword of keywords) {
                if (keyword && lowerDesc === keyword.toLowerCase()) {
                    return 100;
                }
            }
            
            // Contains exact keyword = 90%
            for (const keyword of keywords) {
                if (keyword && keyword.length > 2 && lowerDesc.includes(keyword.toLowerCase())) {
                    return 90;
                }
            }
            
            // Partial keyword match = 75%
            for (const keyword of keywords) {
                if (keyword && keyword.length > 4) {
                    const partial = keyword.toLowerCase().substring(0, 4);
                    if (lowerDesc.includes(partial)) {
                        return 75;
                    }
                }
            }
            
            // Fallback category = 50%
            if (transaction.category === '××—×¨') {
                return 50;
            }
            
            return 65;
        }

        function showImportPreview(transactions) {
            const container = document.getElementById('previewList');
            
            // Group by confidence
            const highConf = transactions.filter(t => t.confidence >= 80);
            const medConf = transactions.filter(t => t.confidence >= 60 && t.confidence < 80);
            const lowConf = transactions.filter(t => t.confidence < 60);
            
            let html = '';
            
            // High confidence section
            if (highConf.length > 0) {
                html += `<div class="mb-4">
                    <h4 class="font-bold mb-3 flex items-center gap-2 text-lg">
                        <span style="color: var(--income-color);">âœ“</span>
                        <span>×–×™×”×•×™ ××•×˜×•××˜×™ ×‘×˜×•×— - ${highConf.length} ×ª× ×•×¢×•×ª</span>
                    </h4>`;
                html += highConf.slice(0, 10).map(t => renderPreviewItem(t)).join('');
                if (highConf.length > 10) {
                    html += `<p class="text-sm mt-2 p-2 rounded" style="color: var(--text-secondary); background: var(--bg-tertiary);">
                        + ×¢×•×“ ${highConf.length - 10} ×ª× ×•×¢×•×ª ×¢× ×–×™×”×•×™ ×‘×˜×•×—...</p>`;
                }
                html += '</div>';
            }
            
            // Medium confidence section
            if (medConf.length > 0) {
                html += `<div class="mb-4">
                    <h4 class="font-bold mb-3 flex items-center gap-2 text-lg">
                        <span style="color: var(--warning-color);">âš </span>
                        <span>×–×™×”×•×™ ×‘×™× ×•× ×™ - ${medConf.length} ×ª× ×•×¢×•×ª</span>
                    </h4>`;
                html += medConf.slice(0, 5).map(t => renderPreviewItem(t)).join('');
                if (medConf.length > 5) {
                    html += `<p class="text-sm mt-2 p-2 rounded" style="color: var(--text-secondary); background: var(--bg-tertiary);">
                        + ×¢×•×“ ${medConf.length - 5} ×ª× ×•×¢×•×ª...</p>`;
                }
                html += '</div>';
            }
            
            // Low confidence section
            if (lowConf.length > 0) {
                html += `<div class="mb-4">
                    <h4 class="font-bold mb-3 flex items-center gap-2 text-lg">
                        <span style="color: var(--expense-color);">âš ï¸</span>
                        <span>×–×™×”×•×™ × ××•×š - ×‘×“×•×§ ××—×¨×™ ×”×™×™×‘×•× (${lowConf.length})</span>
                    </h4>`;
                html += lowConf.map(t => renderPreviewItem(t)).join('');
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function renderPreviewItem(transaction) {
            const typeColor = transaction.type === 'income' ? 'var(--income-color)' : 'var(--expense-color)';
            const typeIcon = transaction.type === 'income' ? 'ğŸ’°' : 'ğŸ’¸';
            const confColor = transaction.confidence >= 80 ? '#166534' : 
                             transaction.confidence >= 60 ? '#92400e' : '#991b1b';
            const confBg = transaction.confidence >= 80 ? '#dcfce7' : 
                          transaction.confidence >= 60 ? '#fef3c7' : '#fee2e2';
            
            return `
                <div class="p-3 rounded-lg transition hover:scale-[1.01]" style="background: var(--bg-tertiary); border-right: 3px solid ${typeColor};">
                    <div class="flex justify-between items-start gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xl">${typeIcon}</span>
                                <span class="font-semibold truncate">${transaction.description}</span>
                            </div>
                            <div class="flex items-center gap-3 text-xs flex-wrap" style="color: var(--text-secondary);">
                                <span>ğŸ“… ${formatDate(transaction.date)}</span>
                                <span class="px-2 py-1 rounded font-medium" style="background: var(--bg-secondary);">
                                    ${transaction.category}
                                </span>
                                <span class="px-2 py-1 rounded font-bold" style="color: ${confColor}; background: ${confBg};">
                                    ${transaction.confidence}% ×‘×™×˜×—×•×Ÿ
                                </span>
                            </div>
                        </div>
                        <div class="text-xl font-bold whitespace-nowrap" style="color: ${typeColor};">
                            ${formatCurrency(transaction.amount)}
                        </div>
                    </div>
                </div>
            `;
        }

        function confirmImport() {
            if (pendingImportTransactions.length === 0) {
                showToast('âŒ ××™×Ÿ ×ª× ×•×¢×•×ª ×œ×™×™×‘×•×', false);
                return;
            }
            
            // Show processing briefly
            document.getElementById('importStep2').classList.add('hidden');
            document.getElementById('importProcessing').classList.remove('hidden');
            
            setTimeout(() => {
                // Add all transactions
                let added = 0;
                for (const trans of pendingImportTransactions) {
                    const transaction = {
                        id: Date.now() + added + Math.random(), // Ensure unique IDs
                        type: trans.type,
                        description: trans.description,
                        amount: trans.amount,
                        category: trans.category,
                        date: trans.date,
                        month: trans.month
                    };
                    
                    transactions.push(transaction);
                    added++;
                }
                
                // Save and update
                saveTransactions();
                updateDashboard();
                
                // Close modal
                closeImportModal();
                
                // Show success with details
                const incomeCount = pendingImportTransactions.filter(t => t.type === 'income').length;
                const expenseCount = pendingImportTransactions.filter(t => t.type === 'expense').length;
                
                showToast(`âœ“ ×™×•×‘××• ${added} ×ª× ×•×¢×•×ª ×‘×”×¦×œ×—×”! (${incomeCount} ×”×›× ×¡×•×ª, ${expenseCount} ×”×•×¦××•×ª)`, false);
                
                // Clear pending
                pendingImportTransactions = [];
                skippedDuplicates = 0;
            }, 500);
        }

        function clamp(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }

        function forecastNextValues(series, count) {
            if (!series.length) return Array(count).fill(0);
            if (series.length === 1) return Array(count).fill(series[0]);

            const n = series.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;

            for (let i = 0; i < n; i++) {
                const x = i;
                const y = series[i];
                sumX += x;
                sumY += y;
                sumXY += x * y;
                sumXX += x * x;
            }

            const denominator = (n * sumXX) - (sumX * sumX);
            const slope = denominator !== 0 ? ((n * sumXY) - (sumX * sumY)) / denominator : 0;
            const intercept = (sumY - slope * sumX) / n;

            const forecast = [];
            for (let i = 0; i < count; i++) {
                const x = n + i;
                let value = slope * x + intercept;
                if (!isFinite(value)) {
                    value = series[series.length - 1];
                }
                forecast.push(Math.max(0, value));
            }

            return forecast;
        }

        function calculateStdDev(values) {
            if (!values.length) return 0;
            const mean = values.reduce((sum, value) => sum + value, 0) / values.length;
            const variance = values.reduce((sum, value) => sum + Math.pow(value - mean, 2), 0) / values.length;
            return Math.sqrt(variance);
        }

        function formatCurrency(amount) {
            return 'â‚ª' + Math.abs(amount).toLocaleString('he-IL', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('he-IL', {
                day: 'numeric',
                month: 'short'
            });
        }

        function formatMonthName(monthStr) {
            const [year, month] = monthStr.split('-');
            const date = new Date(year, parseInt(month) - 1);
            return date.toLocaleDateString('he-IL', {
                month: 'long',
                year: 'numeric'
            });
        }
    </script>
</body>
</html>